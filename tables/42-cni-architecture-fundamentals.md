# 141 - CNI 架构与核心原理 (CNI Architecture & Fundamentals)

> **适用版本**: Kubernetes v1.25 - v1.32 | **难度**: 高级 | **最后更新**: 2026-01

---

## 1. Kubernetes 网络模型

### 核心原则

| 原则 | 说明 |
|:---|:---|
| **Pod 间通信** | 所有 Pod 可以直接通信，无需 NAT |
| **Node-Pod 通信** | 节点可以直接与所有 Pod 通信 |
| **Pod IP 一致性** | Pod 看到的自身 IP 与其他 Pod 看到的相同 |

### 网络分层架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes 网络栈                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 4: Service 层                                            │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │ ClusterIP   │  │  NodePort   │  │LoadBalancer │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 3: kube-proxy 层                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │  iptables   │  │    IPVS     │  │  eBPF/nft   │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 2: CNI 层                                                │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │   Flannel   │  │   Calico    │  │   Cilium    │             │   │
│   │  │   Terway    │  │   Antrea    │  │  WeaveNet   │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 1: 物理/虚拟网络                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │   VXLAN     │  │    BGP      │  │  VPC/ENI    │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. CNI 规范与接口

### 2.1 CNI 操作类型

| 操作 | 触发时机 | 说明 |
|:---|:---|:---|
| **ADD** | Pod 创建 | 创建网络命名空间、分配 IP、配置路由 |
| **DEL** | Pod 删除 | 清理网络资源、释放 IP |
| **CHECK** | 健康检查 | 验证网络配置正确性 (可选) |
| **VERSION** | 版本查询 | 返回支持的 CNI 版本 |

### 2.2 CNI 配置文件结构

```json
{
  "cniVersion": "1.0.0",
  "name": "k8s-pod-network",
  "plugins": [
    {
      "type": "calico",
      "log_level": "info",
      "datastore_type": "kubernetes",
      "nodename": "__KUBERNETES_NODE_NAME__",
      "mtu": 1440,
      "ipam": {
        "type": "calico-ipam"
      },
      "policy": {
        "type": "k8s"
      },
      "kubernetes": {
        "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
      }
    },
    {
      "type": "portmap",
      "snat": true,
      "capabilities": {"portMappings": true}
    },
    {
      "type": "bandwidth",
      "capabilities": {"bandwidth": true}
    }
  ]
}
```

### 2.3 CNI 环境变量

| 变量 | 说明 |
|:---|:---|
| `CNI_COMMAND` | ADD/DEL/CHECK/VERSION |
| `CNI_CONTAINERID` | 容器 ID |
| `CNI_NETNS` | 网络命名空间路径 |
| `CNI_IFNAME` | 接口名称 (通常为 eth0) |
| `CNI_PATH` | CNI 插件搜索路径 |
| `CNI_ARGS` | 额外参数 |

---

## 3. Pod 网络创建流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Pod 网络初始化流程                                │
└─────────────────────────────────────────────────────────────────────────┘

  API Server              kubelet                CNI Plugin           IPAM
      │                      │                      │                  │
      │  1. Pod 调度到节点   │                      │                  │
      ├─────────────────────▶│                      │                  │
      │                      │                      │                  │
      │                      │  2. 创建 Sandbox     │                  │
      │                      ├────────┐             │                  │
      │                      │        │             │                  │
      │                      │◀───────┘             │                  │
      │                      │                      │                  │
      │                      │  3. 调用 CNI ADD     │                  │
      │                      ├─────────────────────▶│                  │
      │                      │                      │                  │
      │                      │                      │  4. 请求 IP      │
      │                      │                      ├─────────────────▶│
      │                      │                      │                  │
      │                      │                      │  5. 分配 IP      │
      │                      │                      │◀─────────────────┤
      │                      │                      │                  │
      │                      │                      │  6. 创建 veth    │
      │                      │                      ├────────┐         │
      │                      │                      │        │         │
      │                      │                      │◀───────┘         │
      │                      │                      │                  │
      │                      │                      │  7. 配置路由     │
      │                      │                      ├────────┐         │
      │                      │                      │        │         │
      │                      │                      │◀───────┘         │
      │                      │                      │                  │
      │                      │  8. 返回 IP 配置     │                  │
      │                      │◀─────────────────────┤                  │
      │                      │                      │                  │
      │                      │  9. 启动容器         │                  │
      │                      ├────────┐             │                  │
      │                      │        │             │                  │
      │                      │◀───────┘             │                  │
      │                      │                      │                  │
```

---

## 4. CNI 插件对比

| 特性 | Flannel | Calico | Cilium | Terway | Antrea |
|:---|:---:|:---:|:---:|:---:|:---:|
| **网络模式** | Overlay | Overlay/BGP | Overlay/Native | VPC | Overlay/NoEncap |
| **NetworkPolicy** | ❌ | ✅ | ✅ | ✅ | ✅ |
| **eBPF 支持** | ❌ | ✅ (部分) | ✅ (原生) | ✅ | ✅ |
| **加密** | ❌ | ✅ (WireGuard) | ✅ | ❌ | ✅ (IPSec) |
| **多集群** | ❌ | ✅ | ✅ | ❌ | ✅ |
| **Service Mesh** | ❌ | ❌ | ✅ | ❌ | ❌ |
| **Windows** | ✅ | ✅ | ❌ | ❌ | ✅ |
| **复杂度** | 低 | 中 | 高 | 中 | 中 |
| **性能** | 中 | 高 | 高 | 高 | 高 |

---

## 5. Overlay 网络原理

### 5.1 VXLAN 封装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         VXLAN 封装结构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   原始数据包:                                                            │
│   ┌────────────┬────────────┬────────────┬──────────────────────────┐   │
│   │  Pod Eth   │   Pod IP   │    TCP     │        Payload           │   │
│   │   Header   │   Header   │   Header   │                          │   │
│   └────────────┴────────────┴────────────┴──────────────────────────┘   │
│                                                                          │
│   VXLAN 封装后:                                                          │
│   ┌──────────┬──────────┬────────┬────────┬────────────────────────┐    │
│   │ Outer    │ Outer IP │  UDP   │ VXLAN  │    原始数据包          │    │
│   │ Ethernet │  Header  │ Header │ Header │    (上面的内容)        │    │
│   │ 14 bytes │ 20 bytes │8 bytes │8 bytes │                        │    │
│   └──────────┴──────────┴────────┴────────┴────────────────────────┘    │
│                                                                          │
│   额外开销: 50 bytes (MTU: 1500 → 实际 1450)                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 VXLAN 跨节点通信

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Node 1 (10.0.1.10)                  Node 2 (10.0.1.20)                 │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │  Pod A              │             │  Pod B              │            │
│  │  IP: 10.244.1.10    │             │  IP: 10.244.2.20    │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │ veth                                 │ veth                │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │     cni0 Bridge     │             │     cni0 Bridge     │            │
│  │  IP: 10.244.1.1     │             │  IP: 10.244.2.1     │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │                                      │                     │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │  flannel.1 (VTEP)   │────VXLAN───▶│  flannel.1 (VTEP)   │            │
│  │  IP: 10.244.1.0     │   隧道      │  IP: 10.244.2.0     │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │                                      │                     │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │       eth0          │             │       eth0          │            │
│  │  IP: 10.0.1.10      │─────────────│  IP: 10.0.1.20      │            │
│  └─────────────────────┘   物理网络   └─────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 路由模式原理 (BGP/host-gw)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Node 1 (10.0.1.10)                  Node 2 (10.0.1.20)                 │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │  Pod A              │             │  Pod B              │            │
│  │  IP: 10.244.1.10    │             │  IP: 10.244.2.20    │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │ veth                                 │ veth                │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │      cali*          │             │      cali*          │            │
│  │   路由到 eth0       │             │   路由到 eth0       │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │                                      │                     │
│   路由表:                               路由表:                          │
│   10.244.2.0/24 via 10.0.1.20          10.244.1.0/24 via 10.0.1.10     │
│            │                                      │                     │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │       eth0          │             │       eth0          │            │
│  │  IP: 10.0.1.10      │─────────────│  IP: 10.0.1.20      │            │
│  └─────────────────────┘   直接路由   └─────────────────────┘            │
│                         (无封装开销)                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### 路由模式优势

| 特性 | Overlay (VXLAN) | 路由模式 (BGP) |
|:---|:---|:---|
| MTU 开销 | ~50 bytes | 0 |
| 延迟 | 较高 | 较低 |
| 网络要求 | 无特殊要求 | L2 互通或 BGP 支持 |
| 调试难度 | 较高 | 较低 |

---

## 7. IPAM (IP 地址管理)

### 7.1 IPAM 类型

| 类型 | 说明 | 适用场景 |
|:---|:---|:---|
| **host-local** | 每节点独立 IP 段 | Flannel |
| **calico-ipam** | 全局 IP 池，按块分配 | Calico |
| **whereabouts** | 跨节点 IP 池 | 多租户 |
| **VPC IPAM** | 云厂商 VPC IP 直接分配 | Terway、AWS VPC CNI |

### 7.2 Calico IPPool 配置

```yaml
apiVersion: crd.projectcalico.org/v1
kind: IPPool
metadata:
  name: default-ippool
spec:
  cidr: 10.244.0.0/16
  ipipMode: CrossSubnet      # 跨子网使用 IPIP
  vxlanMode: Never
  natOutgoing: true
  nodeSelector: all()
  blockSize: 26              # 每节点 64 个 IP (/26)
---
# 特定节点池
apiVersion: crd.projectcalico.org/v1
kind: IPPool
metadata:
  name: gpu-node-pool
spec:
  cidr: 10.245.0.0/16
  ipipMode: Always
  natOutgoing: true
  nodeSelector: hardware == 'gpu'
```

---

## 8. 故障排查

### 8.1 常用诊断命令

```bash
# 查看 CNI 配置
ls -la /etc/cni/net.d/
cat /etc/cni/net.d/10-calico.conflist

# 查看 CNI 插件
ls -la /opt/cni/bin/

# 查看 Pod 网络命名空间
crictl pods
crictl inspectp <pod-id> | jq '.info.runtimeSpec.linux.namespaces'

# 进入 Pod 网络命名空间
nsenter -t $(crictl inspect <container-id> | jq '.info.pid') -n ip addr

# 检查路由表
ip route show
ip route get <pod-ip>

# 检查 VXLAN 接口
ip -d link show flannel.1
bridge fdb show dev flannel.1

# 抓包分析
tcpdump -i eth0 -n port 4789  # VXLAN
tcpdump -i cali+ -n           # Calico 接口
```

### 8.2 常见问题

| 问题 | 可能原因 | 解决方案 |
|:---|:---|:---|
| Pod 无法获取 IP | CNI 插件未安装/配置错误 | 检查 /etc/cni/net.d/ |
| Pod 间无法通信 | 网络策略/路由问题 | 检查 NetworkPolicy、路由表 |
| 跨节点通信失败 | 防火墙/VXLAN 端口 | 检查 UDP 4789/8472 |
| DNS 解析失败 | CoreDNS 问题 | 检查 CoreDNS Pod 状态 |
| 网络性能差 | MTU 配置不当 | 调整 MTU (VXLAN: 1450) |

---

## 9. 最佳实践

| 类别 | 建议 |
|:---|:---|
| **CNI 选择** | 简单场景用 Flannel，需要 NetworkPolicy 用 Calico/Cilium |
| **网络模式** | 同子网用 host-gw/BGP，跨子网用 VXLAN |
| **MTU** | VXLAN 设置为 1450，避免分片 |
| **IP 规划** | 预留足够的 Pod CIDR，避免与 VPC 冲突 |
| **NetworkPolicy** | 默认拒绝，显式允许 |
| **监控** | 监控 CNI Pod 状态、网络延迟 |

---

**表格底部标记**: Kusheet Project | 作者: Allen Galler (allengaller@gmail.com)
