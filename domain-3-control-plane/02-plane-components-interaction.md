# 控制平面组件交互详解 (Control Plane Components Interaction Deep Dive)

> **适用版本**: Kubernetes v1.25 - v1.32 | **最后更新**: 2026-02 | **文档类型**: 深度技术解析

---

## 目录

1. [组件间通信协议](#1-组件间通信协议)
2. [API Server核心交互](#2-api-server核心交互)
3. [控制器管理器交互](#3-控制器管理器交互)
4. [调度器交互机制](#4-调度器交互机制)
5. [etcd存储交互](#5-etcd存储交互)
6. [工作节点通信](#6-工作节点通信)
7. [认证授权流程](#7-认证授权流程)
8. [事件传播机制](#8-事件传播机制)

---

## 1. 组件间通信协议

### 1.1 通信协议栈概览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Control Plane Communication Stack                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  应用层 (Application Layer)                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  REST API (JSON/YAML)                                                    │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ CRUD操作    │ │ Watch机制   │ │ List/Get    │ │ Patch/Merge         ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  传输层 (Transport Layer)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  HTTP/1.1 + HTTP/2                                                       │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Keep-Alive  │ │ Chunked     │ │ Compression │ │ Multiplexing        ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  安全层 (Security Layer)                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  TLS 1.2/1.3 + mTLS                                                      │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ 证书认证    │ │ 客户端证书  │ │ 加密套件    │ │ 会话复用            ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  底层 (Infrastructure Layer)                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  TCP/IP + gRPC                                                           │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ 连接管理    │ │ 流控制      │ │ 错误处理    │ │ 负载均衡            ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 协议选择矩阵

| 场景 | 协议 | 使用组件 | 优势 | 注意事项 |
|------|------|----------|------|----------|
| **API访问** | HTTPS REST | 客户端↔API Server | 标准化，易调试 | 性能相对较低 |
| **内部通信** | gRPC | API Server↔etcd | 高性能，流式传输 | 调试复杂 |
| **控制器通信** | HTTP长连接 | Controller↔API Server | Watch机制支持 | 连接管理复杂 |
| **节点通信** | gRPC + CRI | Kubelet↔Runtime | 标准化接口 | 需要CRI实现 |
| **存储通信** | gRPC + etcd | API Server↔etcd | 一致性保证 | 网络延迟敏感 |

### 1.3 连接池管理

```go
// API Server连接池配置示例
type ConnectionPoolConfig struct {
    MaxIdleConns        int           // 最大空闲连接数
    MaxConnsPerHost     int           // 每主机最大连接数
    IdleConnTimeout     time.Duration // 空闲连接超时
    TLSHandshakeTimeout time.Duration // TLS握手超时
    ExpectContinueTimeout time.Duration // Expect Continue超时
}

// 典型生产配置
var productionConfig = ConnectionPoolConfig{
    MaxIdleConns:        100,
    MaxConnsPerHost:     50,
    IdleConnTimeout:     90 * time.Second,
    TLSHandshakeTimeout: 10 * time.Second,
    ExpectContinueTimeout: 1 * time.Second,
}
```

---

## 2. API Server核心交互

### 2.1 API Server架构分层

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          API Server Architecture Layers                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Layer 7: API路由层                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           API Routes                                    │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ /api/v1     │ │ /apis/apps  │ │ /metrics    │ │ /healthz            ││    │
│  │  │ /api/v1beta1│ │ /logs       │ │ /debug      │ │ /livez              ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  Layer 6: 认证授权层                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Authentication & Authorization                      │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ AuthN Chain │ │ AuthZ Chain │ │ Impersonate │ │ User Info           ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  Layer 5: 准入控制层                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Admission Control                                │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Mutating    │ │ Validating  │ │ Initializer │ │ ResourceQuota       ││    │
│  │  │ Webhook     │ │ Webhook     │ │ Admission   │ │ Admission           ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  Layer 4: 存储接口层                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           Storage Interface                              │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ RESTStorage │ │ WatchCache  │ │ Codec       │ │ Object Validation   ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  Layer 3: etcd客户端层                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         etcd Client Layer                                │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ gRPC Client │ │ Load Balancer│ │ Retry Logic │ │ Circuit Breaker     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  Layer 2: etcd集群层                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           etcd Cluster                                   │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ etcd Member │ │ etcd Member │ │ etcd Member │ │                     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 请求处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          API Server Request Processing                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  客户端请求到达:                                                                │
│  POST /api/v1/namespaces/default/pods                                           │
│  Content-Type: application/json                                                 │
│  Authorization: Bearer <token>                                                  │
│        │                                                                        │
│        ▼                                                                        │
│  1. 路由匹配                                                                    │
│     ├── 解析URL路径: /api/v1/namespaces/default/pods                           │
│     ├── 匹配API组: core/v1                                                     │
│     ├── 确定资源类型: Pod                                                      │
│     └── 选择处理函数: createPodHandler                                         │
│        │                                                                        │
│        ▼                                                                        │
│  2. 认证处理 (Authentication)                                                  │
│     ├── 提取认证信息: Bearer Token                                             │
│     ├── TokenReview请求到认证服务                                              │
│     ├── 验证Token有效性                                                        │
│     └── 返回用户信息: {user: "system:serviceaccount:default:deployer"}         │
│        │                                                                        │
│        ▼                                                                        │
│  3. 授权处理 (Authorization)                                                   │
│     ├── 构造授权请求:                                                           │
│     │   Subject: system:serviceaccount:default:deployer                        │
│     │   Verb: create                                                           │
│     │   Resource: pods                                                         │
│     │   Namespace: default                                                     │
│     ├── 查询RBAC规则                                                            │
│     └── 决策: Allow/Deny                                                       │
│        │                                                                        │
│        ▼                                                                        │
│  4. 准入控制 (Admission Control)                                               │
│     ├── Mutating阶段:                                                           │
│     │   ├─ ResourceQuota准入控制器                                            │
│     │   │  检查命名空间配额                                                   │
│     │   │  添加默认资源请求/限制                                              │
│     │   └─ LimitRanger准入控制器                                              │
│     │      验证资源限制合规性                                                 │
│     ├── Validating阶段:                                                         │
│     │   ├─ PodSecurityPolicy控制器                                            │
│     │   │  验证Pod安全策略                                                │
│     │   └─ 自定义Validating Webhook                                           │
│     │      调用外部验证服务                                                   │
│     └── 最终决策: Accept/Reject                                                │
│        │                                                                        │
│        ▼                                                                        │
│  5. 对象验证与转换                                                              │
│     ├── 验证对象字段合法性                                                      │
│     ├── 转换到内部版本(internal version)                                       │
│     ├── 设置默认值                                                              │
│     └── 生成ResourceVersion                                                    │
│        │                                                                        │
│        ▼                                                                        │
│  6. 存储操作                                                                    │
│     ├── 写入etcd:                                                               │
│     │   PUT /registry/pods/default/my-pod                                     │
│     │   {"kind":"Pod","apiVersion":"v1",...}                                  │
│     ├── etcd Raft协议复制                                                      │
│     └── 返回创建后的对象                                                        │
│        │                                                                        │
│        ▼                                                                        │
│  7. 响应返回                                                                    │
│     HTTP 201 Created                                                            │
│     Content-Type: application/json                                              │
│     {                                                                           │
│       "kind": "Pod",                                                            │
│       "metadata": {                                                             │
│         "name": "my-pod",                                                       │
│         "namespace": "default",                                                 │
│         "resourceVersion": "12345",                                             │
│         "uid": "a1b2c3d4-e5f6-7890"                                            │
│       },                                                                        │
│       ...                                                                       │
│     }                                                                           │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Watch机制详解

#### Watch连接建立

```http
# Watch请求示例
GET /api/v1/pods?watch=true&resourceVersion=12345 HTTP/1.1
Host: apiserver.cluster.local
Authorization: Bearer <token>
Connection: keep-alive
Accept: application/json

# 响应流开始
HTTP/1.1 200 OK
Content-Type: application/json
Transfer-Encoding: chunked
Connection: keep-alive

{"type":"ADDED","object":{"kind":"Pod","metadata":{"name":"pod-1",...}}}
{"type":"MODIFIED","object":{"kind":"Pod","metadata":{"name":"pod-1",...}}}
{"type":"DELETED","object":{"kind":"Pod","metadata":{"name":"pod-1",...}}}
...
```

#### Watch缓存机制

```
Watch Cache 架构:

┌─────────────────────────────────────────────────────────────────────────┐
│                           Watch Cache                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        Cache Store                              │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │    │
│  │  │ Pods Cache  │ │ Nodes Cache │ │ Services    │               │    │
│  │  │ (LRU)       │ │ (LRU)       │ │ Cache       │               │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│          │                                                              │
│          ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                      Watcher Registry                           │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │    │
│  │  │ Watcher-1   │ │ Watcher-2   │ │ Watcher-N   │               │    │
│  │  │ (/pods)     │ │ (/nodes)    │ │ (/services) │               │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│          │                                                              │
│          ▼                                                              │
│     事件分发:                                                            │
│     ├── 根据ResourceVersion过滤                                          │
│     ├── 匹配LabelSelector                                               │
│     ├── 字段选择器过滤                                                   │
│     └── 推送给对应Watcher                                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 控制器管理器交互

### 3.1 控制器管理器架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Controller Manager Architecture                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Leader Election                                  │    │
│  │  ┌─────────────┐                                                        │    │
│  │  │ Lease API   │ ── 竞争成为Leader                                     │    │
│  │  │ Coordination│                                                        │    │
│  │  └─────────────┘                                                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Shared Informers                                    │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Pod Informer│ │ Node Informer│ │ Service     │ │ Custom Resource     ││    │
│  │  │             │ │             │ │ Informer    │ │ Informer            ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Work Queues                                      │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Rate Limit  │ │ Delaying    │ │ FIFO        │ │ Custom              ││    │
│  │  │ Queue       │ │ Queue       │ │ Queue       │ │ Queue               ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Controller Workers                                  │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Worker Pool │ │ Concurrent  │ │ Error       │ │ Metrics             ││    │
│  │  │             │ │ Processing  │ │ Handling    │ │ Collection          ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Informer工作机制

#### Informer初始化流程

```go
// Informer工厂创建示例
func NewSharedInformerFactory(client kubernetes.Interface, defaultResync time.Duration) SharedInformerFactory {
    factory := &sharedInformerFactory{
        client:           client,
        defaultResync:    defaultResync,
        informers:        make(map[reflect.Type]cache.SharedIndexInformer),
        startedInformers: make(map[reflect.Type]bool),
    }
    
    // 为不同资源类型创建Informer
    factory.informers[corev1.SchemeGroupVersion.WithKind("Pod")] = 
        corev1informer.NewPodInformer(client, metav1.NamespaceAll, defaultResync, cache.Indexers{})
        
    factory.informers[corev1.SchemeGroupVersion.WithKind("Node")] = 
        corev1informer.NewNodeInformer(client, defaultResync, cache.Indexers{})
        
    return factory
}
```

#### Reflector核心逻辑

```go
// Reflector核心工作循环
func (r *Reflector) Run(stopCh <-chan struct{}) {
    klog.V(3).Infof("Starting reflector %s (%s) from %s", r.expectedTypeName, r.period.String(), r.name)
    
    wait.BackoffUntil(func() {
        if err := r.ListAndWatch(stopCh); err != nil {
            utilruntime.HandleError(err)
        }
    }, r.backoffManager, true, stopCh)
}

func (r *Reflector) ListAndWatch(stopCh <-chan struct{}) error {
    // 1. 列出所有资源
    list, err := r.listerWatcher.List(options)
    if err != nil {
        return err
    }
    
    // 2. 存储到DeltaFIFO队列
    if err := r.syncWith(list, resourceVersion); err != nil {
        return err
    }
    
    // 3. 启动Watch监听
    for {
        w, err := r.listerWatcher.Watch(options)
        if err != nil {
            return err
        }
        
        // 4. 处理Watch事件
        if err := r.watchHandler(w, &resourceVersion, resyncerrc, stopCh); err != nil {
            return err
        }
    }
}
```

---

## 4. 调度器交互机制

### 4.1 调度器架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Scheduler Architecture                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Scheduling Queue                                │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ ActiveQ     │ │ BackoffQ    │ │ Unschedulable│ │ Pending             ││    │
│  │  │ (heap)      │ │ (heap)      │ │ Pods         │ │ Plugins             ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Scheduling Framework                               │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ PreFilter   │ │ Filter      │ │ PostFilter  │ │ PreScore            ││    │
│  │  │ Plugins     │ │ Plugins     │ │ Plugins     │ │ Plugins             ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Score       │ │ Reserve     │ │ Permit      │ │ PreBind             ││    │
│  │  │ Plugins     │ │ Plugins     │ │ Plugins     │ │ Plugins             ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Node Cache                                      │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Node Info   │ │ Image States│ │ Volume Info │ │ Taint/Toleration    ││    │
│  │  │ Snapshot    │ │ Cache       │ │ Cache       │ │ Cache               ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 调度流程详解

#### 调度周期(Scheduling Cycle)

```go
// 调度器主循环
func (sched *Scheduler) scheduleOne(ctx context.Context) {
    // 1. 从队列获取待调度Pod
    podInfo := sched.NextPod()
    pod := podInfo.Pod
    
    klog.V(3).Infof("Attempting to schedule pod: %v", pod.Name)
    
    // 2. 执行调度周期
    scheduleResult, err := sched.Algorithm.Schedule(ctx, sched.Extenders, pod)
    if err != nil {
        // 处理调度失败
        sched.handleSchedulingFailure(podInfo, err, ReasonUnschedulable)
        return
    }
    
    // 3. 执行绑定周期
    assumedPodInfo := podInfo.DeepCopy()
    assumedPodInfo.Pod.Spec.NodeName = scheduleResult.SuggestedHost
    
    // 4. 预留资源
    if err := sched.assume(assumedPodInfo); err != nil {
        sched.handleSchedulingFailure(podInfo, err, ReasonUnschedulable)
        return
    }
    
    // 5. 异步绑定
    go func() {
        bindingCycleCtx, cancel := context.WithCancel(ctx)
        defer cancel()
        
        if err := sched.bind(bindingCycleCtx, assumedPodInfo, scheduleResult.SuggestedHost, nil); err != nil {
            sched.handleBindingFailure(assumedPodInfo, err)
        }
    }()
}
```

---

## 5. etcd存储交互

### 5.1 etcd客户端架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          etcd Client Architecture                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Client Interface                                │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ KV Interface│ │ Watch       │ │ Lease       │ │ Maintenance         ││    │
│  │  │             │ │ Interface   │ │ Interface   │ │ Interface           ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                      Client Implementation                              │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ gRPC Client │ │ Load        │ │ Retry       │ │ Balancer            ││    │
│  │  │ Connection  │ │ Balancer    │ │ Logic       │ │ (RoundRobin)        ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         etcd Cluster                                    │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ etcd-1      │ │ etcd-2      │ │ etcd-3      │ │                     ││    │
│  │  │ (Leader)    │ │ (Follower)  │ │ (Follower)  │ │                     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 工作节点通信

### 6.1 Kubelet与API Server交互

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Kubelet-API Server Interaction                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Kubelet 主要职责:                                                              │
│  1. Pod生命周期管理                                                             │
│  2. 容器运行时交互                                                              │
│  3. 节点状态上报                                                                │
│  4. 卷管理                                                                      │
│  5. 镜像管理                                                                    │
│                                                                                  │
│  通信模式:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           Bidirectional                                 │    │
│  │  ┌─────────────┐                                          ┌─────────────┐│    │
│  │  │   Kubelet   │◄───────────── Watch ─────────────────────┤ API Server  ││    │
│  │  │             │                                          │             ││    │
│  │  │  - SyncLoop │────────────── Update Status ────────────►│  - CRUD     ││    │
│  │  │  - PLEG     │                                          │  - Watch    ││    │
│  │  │  - Probe    │◄───────────── Pod Config ───────────────┤  - List     ││    │
│  │  └─────────────┘                                          └─────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 认证授权流程

### 7.1 认证链(Authentication Chain)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Authentication Chain                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  认证阶段1: 客户端证书认证                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Client Certificate Authentication                                      │    │
│  │  ├── 验证证书链有效性                                                    │    │
│  │  ├── 检查证书吊销列表(CRL)                                               │    │
│  │  ├── 验证证书扩展字段                                                    │    │
│  │  └── 提取Subject信息 (CN=system:node:node-1)                            │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  认证阶段2: Bearer Token认证                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Bearer Token Authentication                                            │    │
│  │  ├── JWT Token解析                                                       │    │
│  │  ├── 验证签名有效性                                                      │    │
│  │  ├── 检查过期时间                                                        │    │
│  │  └── 提取Claims信息 (sub, iss, aud等)                                   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  认证阶段3: Webhook认证                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Webhook Authentication                                                 │    │
│  │  ├── 构造TokenReview请求                                                 │    │
│  │  ├── 调用外部认证服务                                                    │    │
│  │  ├── 处理认证响应                                                        │    │
│  │  └── 返回用户信息                                                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  最终用户信息:                                                                  │
│  {                                                                              │
│    "username": "system:serviceaccount:default:deployer",                       │
│    "uid": "12345678-1234-1234-1234-123456789012",                              │
│    "groups": ["system:serviceaccounts", "system:authenticated"],               │
│    "extra": {                                                                   │
│      "authentication.kubernetes.io/pod-name": ["pod-xyz"],                     │
│      "authentication.kubernetes.io/pod-uid": ["87654321-4321-4321-4321-210987654321"]│
│    }                                                                            │
│  }                                                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 事件传播机制

### 8.1 事件系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Event System Architecture                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  事件产生层:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          Event Sources                                  │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ Controllers │ │ Kubelet     │ │ Scheduler   │ │ API Server          ││    │
│  │  │             │ │             │ │             │ │                     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  事件处理层:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Event Recorder                                   │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ EventCache  │ │ EventFilter │ │ EventBatch  │ │ EventAggregation    ││    │
│  │  │             │ │             │ │             │ │                     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  事件存储层:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          Event Storage                                   │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ etcd        │ │ API Objects │ │ Event TTL   │ │ Garbage Collection  ││    │
│  │  │             │ │             │ │ Cleanup     │ │                     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│          │                                                                      │
│          ▼                                                                      │
│  事件消费层:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         Event Consumers                                  │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│    │
│  │  │ kubectl     │ │ Dashboard   │ │ Monitoring  │ │ Alerting Systems    ││    │
│  │  │ describe    │ │             │ │ Systems     │ │                     ││    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

控制平面组件间的交互是Kubernetes系统稳定运行的核心。理解这些交互机制有助于：

1. **故障排查**: 快速定位组件间通信问题
2. **性能优化**: 识别瓶颈环节并针对性优化
3. **系统设计**: 构建高可用、高性能的集群架构
4. **安全加固**: 理解攻击面和防护重点

关键要点:
- API Server是所有组件的中心枢纽
- Informer机制实现了高效的资源状态同步
- Watch机制提供了实时的事件推送
- etcd作为唯一的真相源保证了数据一致性
- 认证授权链确保了系统安全

掌握这些交互机制将帮助您更好地运维和优化Kubernetes集群。