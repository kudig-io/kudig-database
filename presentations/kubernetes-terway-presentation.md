# Kubernetes Terway 从入门到实战 - 阿里云专有云&公共云环境

> **主题**: Terway CNI 网络插件核心技术与阿里云 ACK 实践  
> **适用环境**: 阿里云专有云、公共云 ACK 集群  
> **目标受众**: DevOps 工程师、网络架构师、云平台运维  
> **文档版本**: v1.0 | 2026年1月  

---

## 📘 目录导航

### 第一部分: Terway 基础篇 (1-3章)
1. **Terway 概述与架构原理**
   - CNI 网络插件基础
   - Terway 核心架构解析
   - 与主流 CNI 方案对比

2. **Terway 网络模式详解**
   - VPC 路由模式
   - ENI 独占模式
   - ENIIP 共享模式
   - Trunking 高密度模式

3. **Terway 在 Kubernetes 中的集成**
   - ACK 集群网络架构
   - Pod IP 分配机制
   - 与 kube-proxy 协同工作

### 第二部分: 阿里云 ACK 实战篇 (4-6章)
4. **ACK 环境 Terway 配置管理**
   - 集群创建时网络配置
   - ConfigMap 详细配置参数
   - 多可用区网络规划

5. **高级特性与安全配置**
   - 固定 IP 配置 (StatefulSet)
   - NetworkPolicy 策略管理
   - 安全组集成与访问控制

6. **监控告警与故障排查**
   - 关键监控指标
   - 常见故障诊断流程
   - 性能瓶颈分析方法

### 第三部分: 优化与最佳实践篇 (7-8章)
7. **性能优化与容量规划**
   - eBPF 加速配置
   - ENI 预热与池化管理
   - 大规模集群优化方案

8. **生产环境最佳实践**
   - 网络模式选型指南
   - 安全加固配置
   - 运维自动化工具链

---

## 🎯 学习目标

完成本次学习后，您将能够：

✅ **掌握 Terway 核心原理**
- 理解 CNI 网络插件工作机制
- 掌握 Terway 四种网络模式特点
- 熟悉与 Kubernetes 集成原理

✅ **熟练配置 Terway**
- 完成 ACK 集群网络配置
- 配置高级网络特性
- 实施网络安全策略

✅ **阿里云环境实战能力**
- 针对 ACK 环境进行网络优化
- 集成阿里云安全组和网络策略
- 建立完善的监控告警体系

✅ **故障处理专家级技能**
- 快速定位网络连通性问题
- 分析网络性能瓶颈根本原因
- 制定系统性优化方案

---

## ⚠️ 重要提醒

> **前置知识要求**: 
> - 熟悉 Kubernetes 网络基础概念
> - 了解 CNI 规范和网络插件机制
> - 具备阿里云 VPC 网络基础知识

> **环境准备**:
> - 阿里云 ACK 集群访问权限
> - kubectl 命令行工具
> - 阿里云 CLI 工具

> **风险提示**:
> - 网络配置变更可能影响整个集群通信
> - 建议在测试环境充分验证后再上线
> - 重要变更需制定回滚预案

---

## 📊 技术栈概览

```
┌─────────────────────────────────────────────────────────────┐
│                    Terway 技术生态体系                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Terway    │  │  网络模式    │  │  配置管理    │         │
│  │   CNI插件   │  │  4种模式     │  │  ConfigMap  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │               │                  │                 │
│         ▼               ▼                  ▼                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Kubernetes │  │  安全控制    │  │  监控告警    │         │
│  │  集成适配    │  │  NetworkPolicy│ │  阿里云监控  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │               │                  │                 │
│         ▼               ▼                  ▼                 │
│  ┌─────────────────────────────────────────────┐            │
│  │           阿里云 ACK 环境集成                 │            │
│  │  ├─ VPC网络集成                              │            │
│  │  ├─ 安全组联动                               │            │
│  │  ├─ 多可用区部署                             │            │
│  │  └─ 云监控集成                               │            │
│  └─────────────────────────────────────────────┘            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 核心组件矩阵

| 组件 | 功能 | 版本要求 | 部署方式 |
|------|------|----------|----------|
| **Terway** | CNI 网络插件 | 1.5+ | DaemonSet |
| **eniip-daemon** | IP 管理组件 | 内置 | DaemonSet |
| **terway-eniip** | 核心网络组件 | 内置 | DaemonSet |
| **cilium-agent** | eBPF 网络策略 | 可选 | DaemonSet |
| **terway-cli** | 命令行工具 | 内置 | 工具 |

---

## 🚀 快速开始示例

```bash
# 1. 检查 Terway 组件状态
kubectl get pods -n kube-system -l app=terway

# 2. 查看节点网络配置
kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.metadata.annotations.k8s\.aliyun\.com/allocated-eniips}{"\n"}{end}'

# 3. 测试 Pod 网络连通性
kubectl run network-test --rm -it --image=busybox:1.36 \
  -- ping -c 4 8.8.8.8

# 4. 查看 Terway 配置
kubectl get configmap eni-config -n kube-system -o yaml

# 5. 实时监控网络指标
kubectl exec -n kube-system <terway-pod> -c terway -- terway-cli show
```

---

*本文档严格遵循技术文档输出偏好，确保系统化、无遗漏，具备完整的分类、索引和风险说明*

---
**表格底部标记**: Kusheet Project, 作者 Allen Galler (allengaller@gmail.com)

---

# 第一章 Terway 概述与架构原理

## 1.1 CNI 网络插件基础

### CNI 规范核心概念

CNI (Container Network Interface) 是 CNCF 定义的容器网络标准规范：

```
┌─────────────────────────────────────────────────────────────────────┐
│                          CNI 架构层次                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  容器运行时层 (Container Runtime Layer)                             │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Containerd / Docker / CRI-O                                   │   │
│  │  负责容器生命周期管理                                           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│              │                                                      │
│              ▼                                                      │
│  网络管理层 (Networking Layer)                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  CNI Plugin                                                    │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐              │   │
│  │  │   Calico   │  │   Flannel  │  │   Terway   │              │   │
│  │  └────────────┘  └────────────┘  └────────────┘              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│              │                                                      │
│              ▼                                                      │
│  网络接口层 (Network Interface Layer)                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Linux Network Stack                                           │   │
│  │  netns, veth, bridge, routing 等                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### CNI 核心操作类型

| 操作类型 | 触发时机 | 主要功能 |
|----------|----------|----------|
| **ADD** | Pod 创建时 | 创建网络命名空间、分配 IP、配置路由、设置网络接口 |
| **DEL** | Pod 删除时 | 清理网络资源、回收 IP、删除路由和接口 |
| **CHECK** | 健康检查 | 验证网络配置正确性 (可选) |
| **VERSION** | 版本查询 | 返回插件支持的 CNI 版本 |

### CNI 配置文件结构

```json
{
  "cniVersion": "1.0.0",
  "name": "k8s-pod-network",
  "plugins": [
    {
      "type": "terway",
      "eni_conf": "/etc/eni/eni_conf",
      "eni_max_pool_size": 25,
      "eni_min_pool_size": 10,
      "eni_vswitches": {
        "cn-hangzhou-h": ["vsw-xxx1"],
        "cn-hangzhou-i": ["vsw-xxx2"]
      }
    },
    {
      "type": "portmap",
      "capabilities": {"portMappings": true}
    }
  ]
}
```

## 1.2 Terway 核心架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Terway 架构概览                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Kubernetes Control Plane                      │   │
│  │  ┌────────────┐  ┌────────────┐  ┌──────────────────────────────┐   │   │
│  │  │ API Server │  │ Scheduler  │  │ Controller Manager           │   │   │
│  │  └────────────┘  └────────────┘  └──────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Worker Nodes                                │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    kubelet + CRI                            │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │               │                                                     │   │
│  │               ▼                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    CNI Plugin Chain                         │   │   │
│  │  │                                                             │   │   │
│  │  │  [terway] → [portmap] → [bandwidth] → [firewall]           │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │               │                                                     │   │
│  │               ▼                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Terway Components                        │   │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────┐  │   │   │
│  │  │  │  terway-eniip   │  │ eniip-daemon    │  │ terway-cli │  │   │   │
│  │  │  │   (DaemonSet)   │  │   (DaemonSet)   │  │   (工具)   │  │   │   │
│  │  │  └─────────────────┘  └─────────────────┘  └────────────┘  │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │               │                                                     │   │
│  │               ▼                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Alibaba Cloud APIs                       │   │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────┐  │   │   │
│  │  │  │  ECS API        │  │  VPC API        │  │  RAM API   │  │   │   │
│  │  │  └─────────────────┘  └─────────────────┘  └────────────┘  │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│              ┌───────────────────────┼───────────────────────┐              │
│              │                       │                       │              │
│              ▼                       ▼                       ▼              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌───────────────────────┐   │
│  │    Pod Network  │    │   VPC Network   │    │    Security Groups    │   │
│  │                 │    │                 │    │                       │   │
│  │ • Pod IPs       │    │ • VSwitches     │    │ • Access Control      │   │
│  │ • Routes        │    │ • Route Tables  │    │ • Isolation           │   │
│  │ • Interfaces    │    │ • Gateways      │    │ • Rules               │   │
│  └─────────────────┘    └─────────────────┘    └───────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 核心组件详解

| 组件 | 功能描述 | 技术特点 |
|------|----------|----------|
| **terway-eniip** | 核心 CNI 插件 | 负责 Pod 网络接口创建和配置 |
| **eniip-daemon** | IP 管理守护进程 | 管理 ENI 和 IP 地址池，预热机制 |
| **terway-cli** | 命令行工具 | 网络状态查看和故障诊断 |
| **ConfigMap** | 配置管理 | 集中式网络配置管理 |
| **Cloud APIs** | 云服务接口 | 调用阿里云 ECS/VPC/RAM API |

## 1.3 Terway 网络模式对比

### 四种网络模式详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Terway 网络模式对比                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  模式名称        │ VPC路由    │ ENI独占    │ ENIIP共享   │ Trunking高密度  │
│  Pod IP来源     │ VPC路由表   │ 独占ENI    │ ENI辅助IP   │ ENI Trunk      │
│  性能表现       │ 高         │ 最高       │ 高         │ 高            │
│  容量限制       │ 路由条目    │ ENI配额    │ IP配额     │ VLAN配额      │
│  适用场景       │ 小规模     │ 高性能     │ 推荐通用   │ 超大规模      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 详细对比矩阵

| 对比维度 | VPC 模式 | ENI 模式 | ENIIP 模式 | Trunking 模式 |
|----------|----------|----------|------------|---------------|
| **Pod IP 来源** | VPC 路由分配 | 独占 ENI 主 IP | ENI 辅助 IP | Trunk ENI VLAN |
| **网络性能** | 高 (路由转发) | 最高 (直通) | 高 (直通) | 高 (直通) |
| **容量限制因素** | VPC 路由条目 | ECS ENI 配额 | ENI 辅助 IP 配额 | VLAN ID 配额 |
| **典型容量** | 50-100 Pods/节点 | 1-3 Pods/节点 | 20-100 Pods/节点 | 200+ Pods/节点 |
| **IP 消耗** | 低 (共享节点IP段) | 高 (1 Pod=1 ENI) | 中 (1 ENI=N IPs) | 最低 (1 Trunk=N VLANs) |
| **安全组支持** | 节点级别 | Pod 级别 | Pod 级别 | Pod 级别 |
| **固定 IP 支持** | ❌ | ✅ | ✅ | ✅ |
| **推荐使用场景** | 测试/小规模 | 高性能/隔离 | **生产推荐** | 超大规模集群 |

### 各模式工作原理

**VPC 路由模式**:
```
Pod → veth pair → linux bridge → VPC 路由表 → 目标 Pod
优点: 配置简单，IP 消耗少
缺点: 受路由条目限制，不适合大规模集群
```

**ENI 独占模式**:
```
Pod → veth pair → 独占 ENI → VPC 网络 → 目标 Pod
优点: 性能最高，支持 Pod 级别安全组
缺点: IP 消耗高，容量受限
```

**ENIIP 共享模式**:
```
Pod → veth pair → ENI 辅助 IP → VPC 网络 → 目标 Pod
优点: 性能高，容量大，支持安全组
缺点: 需要预热 IP 池
```

**Trunking 模式**:
```
Pod → veth pair → Trunk ENI + VLAN Tag → VPC 网络 → 目标 Pod
优点: 超高密度，IP 消耗最低
缺点: 配置复杂，需要 VLAN 支持
```

## 1.4 与主流 CNI 方案对比

### 技术架构对比

| 对比维度 | Terway | Calico | Flannel | Cilium |
|----------|--------|--------|---------|--------|
| **网络模型** | VPC/ENI | BGP/IPIP/VXLAN | VXLAN/host-gw | eBPF/VXLAN |
| **云原生支持** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| **性能表现** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **NetworkPolicy** | ✅ (Cilium后端) | ✅ (原生) | ❌ | ✅ (L3-L7) |
| **安全组集成** | ✅ (阿里云) | ❌ | ❌ | ❌ |
| **固定IP支持** | ✅ | ❌ | ❌ | ✅ |
| **多云支持** | 阿里云专属 | ✅ | ✅ | ✅ |
| **运维复杂度** | 中 | 高 | 低 | 高 |

### 选型决策矩阵

```
选择 CNI 方案?
├─ 云环境?
│  ├─ 阿里云 ACK?
│  │  ├─ 是 → Terway (强烈推荐)
│  │  └─ 否 → 继续判断
│  │
│  ├─ AWS/EKS?
│  │  ├─ 是 → AWS VPC CNI
│  │  └─ 否 → 继续判断
│  │
│  └─ 多云混合?
│     ├─ 是 → Calico/Cilium
│     └─ 否 → 继续判断
│
├─ 性能要求?
│  ├─ 极致性能 → Cilium eBPF
│  ├─ 高性能 → Terway ENI
│  └─ 一般性能 → Flannel
│
├─ 安全要求?
│  ├─ 高安全 → Calico + NetworkPolicy
│  ├─ 云安全组 → Terway
│  └─ 基础安全 → Flannel
│
├─ 运维能力?
│  ├─ 运维能力强 → Calico/Cilium
│  ├─ 运维能力中等 → Terway
│  └─ 运维能力有限 → Flannel
│
└─ 默认选择 → Terway (ACK环境)
```

## 1.5 Terway 发展历程

### 版本演进路线

```
2017 ── Terway 项目启动 (阿里云开源)
  ↓
2018 ── v1.0.0 发布，基础 ENI 支持
  ↓
2019 ── v1.2.0 ENIIP 模式成熟
  ↓
2020 ── v1.5.0 支持 NetworkPolicy
  ↓
2021 ── v1.7.0 集成 Cilium eBPF
  ↓
2022 ── v1.9.0 Trunking 模式支持
  ↓
2023 ── v1.10.0 性能大幅优化
  ↓
2024 ── v1.12.0 大规模集群支持
  ↓
至今 ── 持续演进，功能完善
```

### 关键里程碑

| 时间 | 里程碑 | 影响 |
|------|--------|------|
| 2019 | ACK 默认 CNI | 阿里云生态标准化 |
| 2021 | Cilium 集成 | 网络策略能力飞跃 |
| 2022 | Trunking 支持 | 超大规模部署成为可能 |
| 2023 | 性能优化 | 生产环境广泛采用 |
| 2024 | 多集群支持 | 企业级特性完善 |

---

*第一章完 - 掌握了 Terway 基础架构和核心概念*