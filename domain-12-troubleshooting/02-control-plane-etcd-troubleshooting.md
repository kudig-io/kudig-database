# 02 - etcd æ•…éšœæ’æŸ¥ (etcd Troubleshooting)

> **é€‚ç”¨ç‰ˆæœ¬**: Kubernetes v1.25-v1.32 | **æœ€åæ›´æ–°**: 2026-02 | **ä¸“å®¶çº§åˆ«**: â­â­â­â­â­ | **å‚è€ƒ**: [etcd.io/docs](https://etcd.io/docs/)

---

## ç›¸å…³æ–‡æ¡£äº¤å‰å¼•ç”¨

### ğŸ”— å…³è”æ•…éšœæ’æŸ¥æ–‡æ¡£
- **[01-API Serveræ•…éšœæ’æŸ¥](./01-control-plane-apiserver-troubleshooting.md)** - etcdæ˜¯API Serverçš„æ ¸å¿ƒå­˜å‚¨ä¾èµ–
- **[31-å¤‡ä»½æ¢å¤æ•…éšœæ’æŸ¥](./31-backup-restore-troubleshooting.md)** - etcdæ•°æ®å¤‡ä»½æ¢å¤æœ€ä½³å®è·µ
- **[34-å‡çº§è¿ç§»æ•…éšœæ’æŸ¥](./34-upgrade-migration-troubleshooting.md)** - etcdç‰ˆæœ¬å‡çº§æ³¨æ„äº‹é¡¹
- **[33-æ€§èƒ½ç“¶é¢ˆæ•…éšœæ’æŸ¥](./33-performance-bottleneck-troubleshooting.md)** - etcdæ€§èƒ½ç›‘æ§åˆ†æ
- **[39-ä¼ä¸šçº§ç›‘æ§å‘Šè­¦ä½“ç³»](./39-enterprise-monitoring-alerting-system.md)** - etcdä¼ä¸šçº§ç›‘æ§å‘Šè­¦é…ç½®

### ğŸ“š æ‰©å±•å­¦ä¹ èµ„æ–™
- **[etcdå®˜æ–¹æ–‡æ¡£](https://etcd.io/docs/)** - etcdå®Œæ•´æŠ€æœ¯æ–‡æ¡£
- **[etcdæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://etcd.io/docs/v3.5/op-guide/performance/)** - ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–
- **[etcdæ•…éšœæ¢å¤æ‰‹å†Œ](https://etcd.io/docs/v3.5/op-guide/recovery/)** - ç¾éš¾æ¢å¤æ“ä½œæŒ‡å—

---

## 1. etcd æ•…éšœè¯Šæ–­æ€»è§ˆ (etcd Diagnosis Overview)

### 1.1 etcd å¸¸è§æ•…éšœç±»å‹

| æ•…éšœç±»å‹ | ç—‡çŠ¶è¡¨ç° | å½±å“èŒƒå›´ | ç´§æ€¥ç¨‹åº¦ |
|---------|---------|---------|---------|
| **é›†ç¾¤ä¸å¯ç”¨** | etcdctlæ— æ³•è¿æ¥ã€leaderé€‰ä¸¾å¤±è´¥ | æ•°æ®å­˜å‚¨å±‚ç˜«ç—ª | P0 - ç´§æ€¥ |
| **æ•°æ®ä¸ä¸€è‡´** | è¯»å†™å¼‚å¸¸ã€key-valueä¸ä¸€è‡´ | æ•°æ®å¯é æ€§å—æŸ | P0 - ç´§æ€¥ |
| **æ€§èƒ½ä¸‹é™** | è¯»å†™å»¶è¿Ÿé«˜ã€ååé‡ä¸‹é™ | APIå“åº”å˜æ…¢ | P1 - é«˜ |
| **ç£ç›˜ç©ºé—´ä¸è¶³** | no space left on device | å†™å…¥æ“ä½œå¤±è´¥ | P1 - é«˜ |
| **æˆå‘˜æ•…éšœ** | member unhealthyã€follower lag | é›†ç¾¤ç¨³å®šæ€§ä¸‹é™ | P2 - ä¸­ |
| **ç½‘ç»œåˆ†åŒº** | ç½‘ç»œéš”ç¦»ã€è„‘è£‚ç°è±¡ | é›†ç¾¤åˆ†è£‚é£é™© | P2 - ä¸­ |

### 1.2 etcd æ¶æ„å…³é”®ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         etcd æ•…éšœè¯Šæ–­æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       Kubernetes ç»„ä»¶                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ API Server  â”‚  â”‚ Scheduler   â”‚  â”‚ Controller  â”‚  â”‚ kubelet     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    etcd Client API (gRPC)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   Raftåè®®    â”‚    â”‚   å­˜å‚¨å¼•æ“    â”‚    â”‚   ç½‘ç»œå±‚     â”‚                   â”‚
â”‚  â”‚ (å…±è¯†ç®—æ³•)   â”‚    â”‚ (boltdb)    â”‚    â”‚ (gRPC)     â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    etcd é›†ç¾¤æˆå‘˜ (é€šå¸¸3/5/7ä¸ª)                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚   etcd-1    â”‚  â”‚   etcd-2    â”‚  â”‚   etcd-3    â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚ (Leader)    â”‚  â”‚ (Follower)  â”‚  â”‚ (Follower)  â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      æŒä¹…åŒ–å­˜å‚¨ (ç£ç›˜)                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚ WALæ—¥å¿—æ–‡ä»¶  â”‚  â”‚ Snapshotå¿«ç…§ â”‚  â”‚ æ•°æ®åº“æ–‡ä»¶   â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. etcd é›†ç¾¤ä¸å¯ç”¨æ•…éšœæ’æŸ¥ (Cluster Unavailability)

### 2.1 æ•…éšœè¯Šæ–­æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      etcd é›†ç¾¤ä¸å¯ç”¨è¯Šæ–­æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   Kubernetes API Server æ— æ³•è®¿é—®etcd                                        â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 1: æ£€æŸ¥æœ¬åœ°etcdè¿›ç¨‹çŠ¶æ€                          â”‚                 â”‚
â”‚   â”‚ systemctl status etcd                                â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ è¿›ç¨‹æœªè¿è¡Œ â”€â”€â–¶ å¯åŠ¨etcdæœåŠ¡                                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 2: æ£€æŸ¥etcdç«¯å£ç›‘å¬                              â”‚                 â”‚
â”‚   â”‚ ss -tlnp | grep 2379                                 â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ ç«¯å£æœªç›‘å¬ â”€â”€â–¶ æ£€æŸ¥é…ç½®/é˜²ç«å¢™                              â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 3: æ£€æŸ¥é›†ç¾¤æˆå‘˜çŠ¶æ€                              â”‚                 â”‚
â”‚   â”‚ ETCDCTL_API=3 etcdctl member list                    â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ æˆå‘˜åˆ—è¡¨å¼‚å¸¸ â”€â”€â–¶ æ£€æŸ¥é›†ç¾¤é…ç½®                                â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 4: æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€                              â”‚                 â”‚
â”‚   â”‚ ETCDCTL_API=3 etcdctl endpoint health --cluster      â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ å¥åº·æ£€æŸ¥å¤±è´¥ â”€â”€â–¶ è½¬å…·ä½“æˆå‘˜æ•…éšœæ’æŸ¥                          â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 5: æ£€æŸ¥ç£ç›˜ç©ºé—´å’ŒIO                              â”‚                 â”‚
â”‚   â”‚ df -h /var/lib/etcd                                  â”‚                 â”‚
â”‚   â”‚ iotop -ao                                            â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†è¯Šæ–­å‘½ä»¤

```bash
# ========== 1. åŸºç¡€çŠ¶æ€æ£€æŸ¥ ==========

# æ£€æŸ¥etcdæœåŠ¡çŠ¶æ€
systemctl status etcd
systemctl is-active etcd

# æ£€æŸ¥etcdè¿›ç¨‹
ps aux | grep etcd
netstat -tlnp | grep etcd

# æ£€æŸ¥ç«¯å£ç›‘å¬
ss -tlnp | grep -E "2379|2380"

# ========== 2. é›†ç¾¤çŠ¶æ€æ£€æŸ¥ ==========

# è®¾ç½®etcdctlç¯å¢ƒå˜é‡
export ETCDCTL_API=3
export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt
export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/server.crt
export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/server.key
export ETCDCTL_ENDPOINTS=https://127.0.0.1:2379

# æ£€æŸ¥é›†ç¾¤æˆå‘˜
etcdctl member list -w table

# æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€
etcdctl endpoint health --cluster

# æ£€æŸ¥é›†ç¾¤çŠ¶æ€è¯¦æƒ…
etcdctl endpoint status --cluster -w table

# ========== 3. é¢†å¯¼è€…é€‰ä¸¾çŠ¶æ€ ==========

# æŸ¥çœ‹å½“å‰é¢†å¯¼è€…
etcdctl endpoint status --cluster -w json | jq '.[] | select(.leaderInfo.leader != "0")'

# æ£€æŸ¥RaftçŠ¶æ€
etcdctl endpoint status --cluster -w json | jq '.[].raftTerm'
etcdctl endpoint status --cluster -w json | jq '.[].raftIndex'
etcdctl endpoint status --cluster -w json | jq '.[].raftAppliedIndex'

# ========== 4. ç£ç›˜å’Œæ€§èƒ½æ£€æŸ¥ ==========

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /var/lib/etcd
du -sh /var/lib/etcd/*

# æ£€æŸ¥WALæ—¥å¿—å¤§å°
ls -lh /var/lib/etcd/member/wal/

# æ£€æŸ¥æ•°æ®åº“å¤§å°
etcdctl endpoint status --cluster -w json | jq '.[].dbSize'

# æ£€æŸ¥ç£ç›˜IOæ€§èƒ½
iostat -x 1 5
iotop -ao

# ========== 5. æ—¥å¿—åˆ†æ ==========

# æŸ¥çœ‹etcdæ—¥å¿—
journalctl -u etcd -f --no-pager

# æŸ¥çœ‹æœ€è¿‘é”™è¯¯æ—¥å¿—
journalctl -u etcd --since "1 hour ago" | grep -i "error\|warn\|panic"

# æ£€æŸ¥walæ—¥å¿—æŸå
etcdctl check perf --load="s"
```

### 2.3 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ä¿¡æ¯ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| `etcdserver: no leader` | é›†ç¾¤åˆ†è£‚/å¤šæ•°æˆå‘˜æ•…éšœ | æ¢å¤å¤šæ•°æˆå‘˜æˆ–é‡æ–°åˆå§‹åŒ– |
| `etcdserver: mvcc: database space exceeded` | æ•°æ®åº“ç©ºé—´æ»¡ | æ¸…ç†æ—§ç‰ˆæœ¬(compact)+ç¢ç‰‡æ•´ç† |
| `etcdserver: walpb: crc mismatch` | WALæ—¥å¿—æŸå | ä»å¿«ç…§æ¢å¤æˆ–é‡æ–°åˆå§‹åŒ– |
| `etcdserver: request timed out` | ç½‘ç»œå»¶è¿Ÿé«˜/ç£ç›˜æ…¢ | æ£€æŸ¥ç½‘ç»œå’Œç£ç›˜æ€§èƒ½ |
| `etcdserver: failed to purge snap file` | ç£ç›˜ç©ºé—´ä¸è¶³ | æ¸…ç†ç£ç›˜ç©ºé—´ |
| `unhealthy cluster` | æˆå‘˜é—´é€šä¿¡å¤±è´¥ | æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œé˜²ç«å¢™ |

---

## 3. æ•°æ®ä¸€è‡´æ€§é—®é¢˜æ’æŸ¥ (Data Consistency Issues)

### 3.1 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

```bash
# ========== 1. æ•°æ®ä¸€è‡´æ€§éªŒè¯ ==========

# æ£€æŸ¥é›†ç¾¤æ•°æ®ä¸€è‡´æ€§
ETCDCTL_API=3 etcdctl --write-out=table endpoint hashkv --cluster

# æ¯”è¾ƒå„æˆå‘˜çš„æ•°æ®å“ˆå¸Œå€¼
for endpoint in 127.0.0.1:2379 127.0.0.2:2379 127.0.0.3:2379; do
  echo "=== $endpoint ==="
  ETCDCTL_API=3 etcdctl --endpoints=https://$endpoint \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/server.crt \
    --key=/etc/kubernetes/pki/etcd/server.key \
    endpoint hashkv
done

# ========== 2. ç‰ˆæœ¬æ£€æŸ¥ ==========

# æ£€æŸ¥etcdç‰ˆæœ¬
etcdctl version
etcd --version

# æ£€æŸ¥é›†ç¾¤ç‰ˆæœ¬å…¼å®¹æ€§
etcdctl endpoint status --cluster -w json | jq '.[].version'

# ========== 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ ==========

# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
ETCDCTL_API=3 etcdctl --write-out=table endpoint status --cluster

# æ£€æŸ¥å‘Šè­¦çŠ¶æ€
ETCDCTL_API=3 etcdctl alarm list

# æ¸…é™¤å‘Šè­¦(å¦‚æœ‰å¿…è¦)
ETCDCTL_API=3 etcdctl alarm disarm
```

### 3.2 æ•°æ®æ¢å¤æ“ä½œ

```bash
# ========== 1. æ•°æ®å¤‡ä»½ ==========

# åˆ›å»ºå¿«ç…§å¤‡ä»½
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d-%H%M%S).db

# éªŒè¯å¿«ç…§å®Œæ•´æ€§
ETCDCTL_API=3 etcdctl snapshot status /backup/etcd-snapshot-*.db -w table

# ========== 2. æ•°æ®æ¢å¤ ==========

# åœæ­¢etcdæœåŠ¡
systemctl stop etcd

# æ¸…ç†æ—§æ•°æ®(è°¨æ…æ“ä½œ!)
mv /var/lib/etcd /var/lib/etcd.backup.$(date +%Y%m%d-%H%M%S)

# ä»å¿«ç…§æ¢å¤
ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot.db \
  --data-dir=/var/lib/etcd \
  --name=etcd-1 \
  --initial-cluster=etcd-1=https://10.0.1.10:2380 \
  --initial-cluster-token=etcd-cluster-1 \
  --initial-advertise-peer-urls=https://10.0.1.10:2380

# å¯åŠ¨etcdæœåŠ¡
systemctl start etcd

# ========== 3. æˆå‘˜æ›¿æ¢ ==========

# ç§»é™¤æ•…éšœæˆå‘˜
ETCDCTL_API=3 etcdctl member remove <member-id>

# æ·»åŠ æ–°æˆå‘˜
ETCDCTL_API=3 etcdctl member add etcd-new --peer-urls=https://10.0.1.11:2380

# åœ¨æ–°èŠ‚ç‚¹ä¸Šå¯åŠ¨etcd(ä½¿ç”¨è¿”å›çš„é…ç½®)
```

---

## 4. æ€§èƒ½é—®é¢˜æ’æŸ¥ (Performance Issues)

### 4.1 æ€§èƒ½ç›‘æ§æŒ‡æ ‡

```bash
# ========== 1. å…³é”®æ€§èƒ½æŒ‡æ ‡ ==========

# è·å–etcdæ€§èƒ½æŒ‡æ ‡
curl -s https://localhost:2379/metrics --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt | grep -E "(etcd_mvcc_db_total_size_in_bytes|etcd_disk_wal_fsync_duration_seconds|etcd_network_peer_round_trip_time_seconds)"

# å…³é”®æŒ‡æ ‡è¯´æ˜:
# etcd_mvcc_db_total_size_in_bytes: æ•°æ®åº“å¤§å°
# etcd_disk_wal_fsync_duration_seconds: WALåˆ·ç›˜å»¶è¿Ÿ
# etcd_network_peer_round_trip_time_seconds: ç½‘ç»œå¾€è¿”æ—¶é—´
# etcd_server_proposals_pending: å¾…å¤„ç†ææ¡ˆæ•°
# etcd_server_proposals_committed_total: å·²æäº¤ææ¡ˆæ•°

# ========== 2. å»¶è¿Ÿåˆ†æ ==========

# æ£€æŸ¥WALåˆ·ç›˜å»¶è¿Ÿ
ETCDCTL_API=3 etcdctl check perf --load="s"

# æŸ¥çœ‹æ…¢æ“ä½œæ—¥å¿—
journalctl -u etcd | grep -i "slow"

# ========== 3. èµ„æºä½¿ç”¨ç›‘æ§ ==========

# CPUå’Œå†…å­˜ä½¿ç”¨
top -p $(pgrep etcd)

# ç£ç›˜IOç»Ÿè®¡
iostat -x 1 10

# ç½‘ç»œæµé‡
iftop -i eth0
```

### 4.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```bash
# ========== 1. æ•°æ®åº“ç»´æŠ¤ ==========

# å‹ç¼©å†å²ç‰ˆæœ¬(å®šæœŸæ‰§è¡Œ)
ETCDCTL_API=3 etcdctl compact $(ETCDCTL_API=3 etcdctl get / --prefix --keys-only --limit=1 -w json | jq -r .header.revision)

# ç¢ç‰‡æ•´ç†
ETCDCTL_API=3 etcdctl defrag --cluster

# ========== 2. é…ç½®ä¼˜åŒ– ==========

# è°ƒæ•´etcdé…ç½®å‚æ•°(/etc/etcd/etcd.conf)
ETCD_HEARTBEAT_INTERVAL=100      # å¿ƒè·³é—´éš”(ms)
ETCD_ELECTION_TIMEOUT=1000       # é€‰ä¸¾è¶…æ—¶(ms)
ETCD_QUOTA_BACKEND_BYTES=8589934592  # æ•°æ®åº“é…é¢(8GB)
ETCD_AUTO_COMPACTION_RETENTION=1 # è‡ªåŠ¨å‹ç¼©ä¿ç•™å°æ—¶æ•°

# ========== 3. ç¡¬ä»¶ä¼˜åŒ– ==========

# ä½¿ç”¨SSDå­˜å‚¨
lsblk -d -o NAME,ROTA  # ROTA=0è¡¨ç¤ºSSD

# è°ƒæ•´æ–‡ä»¶ç³»ç»Ÿ
tune2fs -l /dev/sdX | grep "Filesystem features"

# è°ƒæ•´ç³»ç»Ÿå‚æ•°
echo 'vm.swappiness=1' >> /etc/sysctl.conf
echo 'fs.file-max=1000000' >> /etc/sysctl.conf
```

---

## 5. æˆå‘˜æ•…éšœæ’æŸ¥ (Member Failure)

### 5.1 å•æˆå‘˜æ•…éšœå¤„ç†

```bash
# ========== 1. è¯†åˆ«æ•…éšœæˆå‘˜ ==========

# æ£€æŸ¥æˆå‘˜å¥åº·çŠ¶æ€
ETCDCTL_API=3 etcdctl endpoint health --cluster

# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
ETCDCTL_API=3 etcdctl endpoint status --cluster -w table

# ========== 2. æ•…éšœæˆå‘˜ç§»é™¤ ==========

# è·å–æ•…éšœæˆå‘˜ID
FAULTY_MEMBER_ID=$(ETCDCTL_API=3 etcdctl member list -w json | jq -r '.members[] | select(.name=="etcd-2") | .ID')

# ç§»é™¤æ•…éšœæˆå‘˜
ETCDCTL_API=3 etcdctl member remove $FAULTY_MEMBER_ID

# ========== 3. æ·»åŠ æ–°æˆå‘˜ ==========

# åœ¨æ–°èŠ‚ç‚¹ä¸Šå‡†å¤‡æ•°æ®ç›®å½•
mkdir -p /var/lib/etcd

# æ·»åŠ æˆå‘˜åˆ°é›†ç¾¤
NEW_MEMBER_ID=$(ETCDCTL_API=3 etcdctl member add etcd-new --peer-urls=https://10.0.1.12:2380 | grep "ETCD_INITIAL_CLUSTER=" | cut -d'"' -f2)

# åœ¨æ–°èŠ‚ç‚¹å¯åŠ¨etcd(ä½¿ç”¨è¿”å›çš„é…ç½®)
```

### 5.2 ç½‘ç»œåˆ†åŒºå¤„ç†

```bash
# ========== 1. æ£€æµ‹ç½‘ç»œåˆ†åŒº ==========

# æ£€æŸ¥æˆå‘˜é—´è¿é€šæ€§
for member in etcd-1 etcd-2 etcd-3; do
  echo "=== Checking $member ==="
  ping -c 3 $member
  telnet $member 2379
  telnet $member 2380
done

# ========== 2. è„‘è£‚æ¢å¤ ==========

# æ£€æŸ¥å„åˆ†åŒºçš„æˆå‘˜æ•°é‡
ETCDCTL_API=3 etcdctl member list --write-out=table

# ç¡®ä¿å¤šæ•°æ´¾å­˜æ´»(è‡³å°‘(N/2)+1ä¸ªæˆå‘˜)
# ä¾‹å¦‚: 3èŠ‚ç‚¹é›†ç¾¤éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹åœ¨çº¿

# å¦‚æœæ— æ³•æ¢å¤å¤šæ•°æ´¾ï¼Œéœ€è¦å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
# âš ï¸ æ­¤æ“ä½œä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±!
```

---

## 6. ç”Ÿäº§ç¯å¢ƒåº”æ€¥å¤„ç† (Production Emergency Response)

### 6.1 ç´§æ€¥è¯Šæ–­è„šæœ¬

```bash
#!/bin/bash
# etcd-emergency-check.sh

echo "=== etcd ç´§æ€¥è¯Šæ–­æŠ¥å‘Š ==="
echo "æ—¶é—´: $(date)"
echo ""

# 1. åŸºç¡€çŠ¶æ€æ£€æŸ¥
echo "1. etcdæœåŠ¡çŠ¶æ€:"
systemctl is-active etcd && echo "âœ… æœåŠ¡è¿è¡Œä¸­" || echo "âŒ æœåŠ¡å¼‚å¸¸"

echo -e "\n2. ç«¯å£ç›‘å¬çŠ¶æ€:"
ss -tlnp | grep -E "2379|2380" || echo "âŒ ç«¯å£æœªç›‘å¬"

# 2. é›†ç¾¤å¥åº·æ£€æŸ¥
echo -e "\n3. é›†ç¾¤å¥åº·çŠ¶æ€:"
export ETCDCTL_API=3
export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt
export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/server.crt
export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/server.key
export ETCDCTL_ENDPOINTS=https://127.0.0.1:2379

etcdctl endpoint health --cluster 2>/dev/null || echo "âŒ é›†ç¾¤ä¸å¥åº·"

# 3. ç£ç›˜ç©ºé—´æ£€æŸ¥
echo -e "\n4. ç£ç›˜ç©ºé—´ä½¿ç”¨:"
df -h /var/lib/etcd | tail -1

# 4. æ•°æ®åº“å¤§å°
echo -e "\n5. æ•°æ®åº“å¤§å°:"
etcdctl endpoint status --cluster -w json 2>/dev/null | jq -r '.[].dbSize' | numfmt --to=iec

# 5. æœ€è¿‘é”™è¯¯æ—¥å¿—
echo -e "\n6. æœ€è¿‘é”™è¯¯æ—¥å¿—:"
journalctl -u etcd --since "10 minutes ago" | grep -i "error\|warn" | tail -5

echo -e "\n=== è¯Šæ–­å®Œæˆ ==="
```

### 6.2 æ•…éšœæ¢å¤ä¼˜å…ˆçº§

| æ•…éšœç±»å‹ | æ¢å¤ä¼˜å…ˆçº§ | æ—¶é—´è¦æ±‚ | æ“ä½œæ­¥éª¤ |
|---------|-----------|---------|---------|
| **å®Œå…¨ä¸å¯ç”¨** | æœ€é«˜ | 30åˆ†é’Ÿå†… | 1. æ£€æŸ¥å¤šæ•°æ´¾ 2. æ¢å¤æœåŠ¡ 3. æ•°æ®éªŒè¯ |
| **æ€§èƒ½ä¸¥é‡ä¸‹é™** | é«˜ | 2å°æ—¶å†… | 1. æ€§èƒ½åˆ†æ 2. èµ„æºæ‰©å®¹ 3. å‚æ•°è°ƒä¼˜ |
| **å•æˆå‘˜æ•…éšœ** | ä¸­ | 4å°æ—¶å†… | 1. ç§»é™¤æ•…éšœæˆå‘˜ 2. æ·»åŠ æ–°æˆå‘˜ 3. æ•°æ®åŒæ­¥ |
| **ç£ç›˜ç©ºé—´ä¸è¶³** | é«˜ | 1å°æ—¶å†… | 1. ç´§æ€¥compact 2. ç¢ç‰‡æ•´ç† 3. æ‰©å®¹å­˜å‚¨ |

---

## 7. é¢„é˜²æªæ–½ä¸æœ€ä½³å®è·µ (Prevention & Best Practices)

### 7.1 ç›‘æ§å‘Šè­¦é…ç½®

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: etcd.rules
  rules:
  # etcdä¸å¯ç”¨
  - alert: EtcdDown
    expr: up{job="etcd"} == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "etcdå®ä¾‹ {{ $labels.instance }} ä¸å¯ç”¨"
  
  # etcdæ•°æ®åº“ç©ºé—´ä¸è¶³
  - alert: EtcdDatabaseSpaceExceeded
    expr: etcd_mvcc_db_total_size_in_bytes / etcd_server_quota_backend_bytes > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "etcdæ•°æ®åº“ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡80%"
  
  # etcdæˆå‘˜ä¸å¥åº·
  - alert: EtcdMemberUnhealthy
    expr: etcd_server_has_leader == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "etcdæˆå‘˜ {{ $labels.instance }} æ— é¢†å¯¼è€…"
```

### 7.2 è¿ç»´æ£€æŸ¥æ¸…å•

- [ ] å®šæœŸå¤‡ä»½etcdæ•°æ®ï¼ˆæ¯æ—¥ï¼‰
- [ ] ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ï¼ˆé˜ˆå€¼80%ï¼‰
- [ ] éªŒè¯é›†ç¾¤æˆå‘˜å¥åº·çŠ¶æ€
- [ ] æ£€æŸ¥WALæ—¥å¿—å¢é•¿è¶‹åŠ¿
- [ ] å®šæœŸæ‰§è¡Œæ•°æ®åº“å‹ç¼©å’Œç¢ç‰‡æ•´ç†
- [ ] æµ‹è¯•ç¾éš¾æ¢å¤æµç¨‹
- [ ] ä¿æŒetcdç‰ˆæœ¬æ›´æ–°

---