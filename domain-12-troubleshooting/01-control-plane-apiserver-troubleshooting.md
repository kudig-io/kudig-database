# 01 - API Server æ•…éšœæ’æŸ¥ (API Server Troubleshooting)

> **é€‚ç”¨ç‰ˆæœ¬**: Kubernetes v1.25-v1.32 | **æœ€åæ›´æ–°**: 2026-02 | **å‚è€ƒ**: [kubernetes.io/docs/tasks/debug](https://kubernetes.io/docs/tasks/debug/)

---

## ç›¸å…³æ–‡æ¡£äº¤å‰å¼•ç”¨

### ğŸ”— å…³è”æ•…éšœæ’æŸ¥æ–‡æ¡£
- **[02-etcdæ•…éšœæ’æŸ¥](./02-control-plane-etcd-troubleshooting.md)** - API Serverä¾èµ–etcdå­˜å‚¨ï¼Œetcdæ•…éšœä¼šç›´æ¥å½±å“API Server
- **[03-CNIç½‘ç»œæ•…éšœæ’æŸ¥](./03-networking-cni-troubleshooting.md)** - ç½‘ç»œé—®é¢˜å¯èƒ½å¯¼è‡´API Serveræ— æ³•æ­£å¸¸é€šä¿¡
- **[35-èŠ‚ç‚¹ç»„ä»¶æ•…éšœæ’æŸ¥](./35-node-component-troubleshooting.md)** - kubeletå’Œå®¹å™¨è¿è¡Œæ—¶é—®é¢˜å¯èƒ½å½±å“API Server
- **[30-ç›‘æ§å‘Šè­¦æ•…éšœæ’æŸ¥](./30-monitoring-alerting-troubleshooting.md)** - ç›‘æ§API Serverå¥åº·çŠ¶æ€çš„æœ€ä½³å®è·µ

### ğŸ“š æ‰©å±•å­¦ä¹ èµ„æ–™
- **[Kuberneteså®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/)** - API Serverè¯¦ç»†é…ç½®å‚è€ƒ
- **[API Serveræºç åˆ†æ](https://github.com/kubernetes/kubernetes/tree/master/cmd/kube-apiserver)** - æ·±å…¥ç†è§£å®ç°åŸç†
- **[è®¤è¯æˆæƒæœºåˆ¶è¯¦è§£](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)** - å®‰å…¨é…ç½®æœ€ä½³å®è·µ

---

## 1. API Server æ•…éšœè¯Šæ–­æ€»è§ˆ (API Server Diagnosis Overview)

### 1.1 å¸¸è§æ•…éšœç°è±¡åˆ†ç±»

| æ•…éšœç±»å‹ | ç—‡çŠ¶è¡¨ç° | å½±å“èŒƒå›´ | ç´§æ€¥ç¨‹åº¦ |
|---------|---------|---------|---------|
| **å®Œå…¨ä¸å¯ç”¨** | kubectlæ— æ³•è¿æ¥ã€503 Service Unavailable | æ•´ä¸ªé›†ç¾¤ç˜«ç—ª | P0 - ç´§æ€¥ |
| **æ€§èƒ½ä¸‹é™** | APIå“åº”æ…¢ã€è¶…æ—¶ã€å»¶è¿Ÿé«˜ | æ‰€æœ‰æ“ä½œå˜æ…¢ | P1 - é«˜ |
| **è®¤è¯å¤±è´¥** | 401 Unauthorizedã€è®¤è¯æ‹’ç» | ç”¨æˆ·æ— æ³•æ“ä½œ | P1 - é«˜ |
| **æˆæƒå¤±è´¥** | 403 Forbiddenã€æƒé™æ‹’ç» | éƒ¨åˆ†ç”¨æˆ·å—é™ | P2 - ä¸­ |
| **èµ„æºè®¿é—®å¼‚å¸¸** | ç‰¹å®šAPIç»„/èµ„æºæ— æ³•è®¿é—® | åŠŸèƒ½å—é™ | P2 - ä¸­ |
| **é™æµé—®é¢˜** | 429 Too Many Requests | APIè¯·æ±‚è¢«æ‹’ç» | P2 - ä¸­ |

### 1.2 API Server æ¶æ„å›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Server æ•…éšœè¯Šæ–­æ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       å®¢æˆ·ç«¯è®¿é—®å±‚                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ kubectl â”‚  â”‚ SDKåº”ç”¨  â”‚  â”‚ æ§åˆ¶å™¨   â”‚  â”‚ kubelet â”‚  â”‚ kube-proxyâ”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    è´Ÿè½½å‡è¡¡å±‚ (å¤–éƒ¨LB/nginx)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    API Server å®ä¾‹ (å¤šå‰¯æœ¬)                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚ apiserver-1 â”‚  â”‚ apiserver-2 â”‚  â”‚ apiserver-3 â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   è®¤è¯æ¨¡å—    â”‚    â”‚   æˆæƒæ¨¡å—    â”‚    â”‚   å‡†å…¥æ§åˆ¶    â”‚                   â”‚
â”‚  â”‚ (AuthN)     â”‚    â”‚ (AuthZ)     â”‚    â”‚ (Admission) â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      æ ¸å¿ƒå¤„ç†å±‚                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚  â”‚  APIè·¯ç”±     â”‚    â”‚  é™æµæ§åˆ¶     â”‚    â”‚  å®¡è®¡æ—¥å¿—     â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ (Routing)   â”‚    â”‚ (APF)       â”‚    â”‚ (Audit)     â”‚              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      å­˜å‚¨å±‚ (etcd)                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. API Server å®Œå…¨ä¸å¯ç”¨æ•…éšœæ’æŸ¥ (Complete Unavailability)

### 2.1 æ•…éšœè¯Šæ–­æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Server å®Œå…¨ä¸å¯ç”¨è¯Šæ–­æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   kubectl æ— æ³•è¿æ¥é›†ç¾¤                                                      â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 1: æ£€æŸ¥æœ¬åœ°ç½‘ç»œè¿æ¥                              â”‚                 â”‚
â”‚   â”‚ ping <api-server-ip>                                 â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ ç½‘ç»œä¸é€š â”€â”€â–¶ æ£€æŸ¥ç½‘ç»œé…ç½®/é˜²ç«å¢™                            â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 2: æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨çŠ¶æ€                            â”‚                 â”‚
â”‚   â”‚ curl -vk https://<lb-ip>:6443/healthz                â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ LBæ•…éšœ â”€â”€â–¶ æ£€æŸ¥LBé…ç½®/åç«¯å®ä¾‹                             â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 3: æ£€æŸ¥API Serverå®ä¾‹çŠ¶æ€                        â”‚                 â”‚
â”‚   â”‚ ssh masterèŠ‚ç‚¹ && systemctl status kube-apiserver     â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ å®ä¾‹æœªè¿è¡Œ â”€â”€â–¶ å¯åŠ¨å®ä¾‹/æ£€æŸ¥é…ç½®                            â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 4: æ£€æŸ¥etcdçŠ¶æ€                                  â”‚                 â”‚
â”‚   â”‚ ETCDCTL_API=3 etcdctl endpoint health --cluster       â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€â”€â”€ etcdæ•…éšœ â”€â”€â–¶ è½¬etcdæ•…éšœæ’æŸ¥                                 â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Step 5: æ£€æŸ¥è¯ä¹¦çŠ¶æ€                                  â”‚                 â”‚
â”‚   â”‚ openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -dates       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†è¯Šæ–­å‘½ä»¤

```bash
# ========== 1. åŸºç¡€è¿é€šæ€§æ£€æŸ¥ ==========

# æ£€æŸ¥API Serveræ˜¯å¦å“åº”
curl -vk https://<api-server-ip>:6443/healthz

# æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
curl -k https://<api-server-ip>:6443/version

# æ£€æŸ¥å°±ç»ªçŠ¶æ€
curl -k https://<api-server-ip>:6443/readyz?verbose

# ========== 2. æœ¬åœ°å®ä¾‹æ£€æŸ¥ ==========

# æ£€æŸ¥API Serverè¿›ç¨‹
systemctl status kube-apiserver
ps aux | grep kube-apiserver

# æ£€æŸ¥API Serveræ—¥å¿—
journalctl -u kube-apiserver -f --no-pager
tail -f /var/log/kube-apiserver.log

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /etc/kubernetes/manifests/kube-apiserver.yaml
cat /etc/kubernetes/apiserver.conf

# ========== 3. è¯ä¹¦æ£€æŸ¥ ==========

# æ£€æŸ¥API Serverè¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -dates
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A5 Validity

# æ£€æŸ¥å®¢æˆ·ç«¯è¯ä¹¦
openssl x509 -in /etc/kubernetes/pki/apiserver-kubelet-client.crt -noout -dates

# æ£€æŸ¥CAè¯ä¹¦
openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -dates

# ========== 4. etcdè¿æ¥æ£€æŸ¥ ==========

# æ£€æŸ¥etcdå¥åº·çŠ¶æ€
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  endpoint health

# æ£€æŸ¥etcdæˆå‘˜
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  member list

# ========== 5. èµ„æºä½¿ç”¨æ£€æŸ¥ ==========

# æ£€æŸ¥èŠ‚ç‚¹èµ„æºä½¿ç”¨
top -p $(pgrep kube-apiserver)
free -h
df -h

# æ£€æŸ¥æ–‡ä»¶å¥æŸ„
lsof -p $(pgrep kube-apiserver) | wc -l
cat /proc/sys/fs/file-max
```

### 2.3 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ä¿¡æ¯ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| `connection refused` | API Serveræœªç›‘å¬ç«¯å£ | æ£€æŸ¥ç«¯å£é…ç½®ï¼Œé‡å¯æœåŠ¡ |
| `x509: certificate has expired` | è¯ä¹¦è¿‡æœŸ | ä½¿ç”¨kubeadm renewæˆ–æ‰‹åŠ¨æ›´æ–°è¯ä¹¦ |
| `x509: certificate signed by unknown authority` | CAè¯ä¹¦ä¸åŒ¹é… | æ£€æŸ¥å®¢æˆ·ç«¯CAé…ç½® |
| `etcdserver: leader changed` | etcdé›†ç¾¤ä¸ç¨³å®š | æ£€æŸ¥etcdé›†ç¾¤çŠ¶æ€ |
| `context deadline exceeded` | è¯·æ±‚è¶…æ—¶ | æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿï¼Œè°ƒæ•´è¶…æ—¶é…ç½® |
| `too many open files` | æ–‡ä»¶å¥æŸ„ä¸è¶³ | è°ƒæ•´ulimité™åˆ¶ |

---

## 3. API Server æ€§èƒ½é—®é¢˜æ’æŸ¥ (Performance Issues)

### 3.1 æ€§èƒ½ç›‘æ§æŒ‡æ ‡

```bash
# ========== 1. API Serveræ€§èƒ½æŒ‡æ ‡ ==========

# è·å–API ServeræŒ‡æ ‡
curl -k https://localhost:6443/metrics | grep -E "(apiserver_request_total|apiserver_request_duration_seconds|apiserver_current_inflight_requests)"

# å…³é”®æ€§èƒ½æŒ‡æ ‡è¯´æ˜:
# apiserver_request_total: æ€»è¯·æ±‚æ•°
# apiserver_request_duration_seconds: è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
# apiserver_current_inflight_requests: å½“å‰å¹¶å‘è¯·æ±‚æ•°
# apiserver_dropped_requests_total: è¢«ä¸¢å¼ƒçš„è¯·æ±‚æ•°

# ========== 2. é™æµç›¸å…³æŒ‡æ ‡ ==========

# APF (API Priority and Fairness) æŒ‡æ ‡
curl -k https://localhost:6443/metrics | grep -E "(apiserver_flowcontrol_|priority_level_)"

# æŸ¥çœ‹é™æµé…ç½®
kubectl get flowschemas
kubectl get prioritylevelconfigurations

# ========== 3. èµ„æºæ¶ˆè€—ç›‘æ§ ==========

# CPUå’Œå†…å­˜ä½¿ç”¨
kubectl top pods -n kube-system -l component=kube-apiserver

# æ£€æŸ¥Podèµ„æºé™åˆ¶
kubectl get pod -n kube-system -l component=kube-apiserver -o yaml | grep -A10 resources
```

### 3.2 æ€§èƒ½é—®é¢˜è¯Šæ–­

```bash
# ========== æ…¢è¯·æ±‚åˆ†æ ==========

# æŸ¥æ‰¾æ…¢è¯·æ±‚ (>1s)
curl -k https://localhost:6443/metrics | grep apiserver_request_duration_seconds_bucket | grep 'le="1"' 

# æŒ‰verbç»Ÿè®¡è¯·æ±‚å»¶è¿Ÿ
curl -k https://localhost:6443/metrics | grep '^apiserver_request_duration_seconds_sum{'

# æŒ‰resourceç»Ÿè®¡å»¶è¿Ÿ
curl -k https://localhost:6443/metrics | grep '^apiserver_request_duration_seconds_sum{' | grep 'resource='

# ========== å¹¶å‘åˆ†æ ==========

# å½“å‰å¹¶å‘è¯·æ±‚æ•°
curl -k https://localhost:6443/metrics | grep apiserver_current_inflight_requests

# è¢«æ‹’ç»çš„è¯·æ±‚æ•°
curl -k https://localhost:6443/metrics | grep apiserver_dropped_requests_total

# ========== å®¢æˆ·ç«¯åˆ†æ ==========

# æŒ‰userç»Ÿè®¡è¯·æ±‚é‡
curl -k https://localhost:6443/metrics | grep '^apiserver_request_total{' | grep 'username='

# æŒ‰sourceç»Ÿè®¡è¯·æ±‚æ¥æº
curl -k https://localhost:6443/metrics | grep '^apiserver_request_total{' | grep 'source='
```

### 3.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–æ–¹å‘ | å…·ä½“æªæ–½ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| **æ°´å¹³æ‰©å±•** | å¢åŠ API Serverå‰¯æœ¬æ•° | é«˜å¹¶å‘åœºæ™¯ |
| **å‚ç›´æ‰©å±•** | å¢åŠ CPU/Memoryèµ„æº | å•å®ä¾‹è´Ÿè½½é«˜ |
| **é™æµè°ƒä¼˜** | è°ƒæ•´APFé…ç½® | è¯·æ±‚ä¸å‡è¡¡ |
| **ç¼“å­˜ä¼˜åŒ–** | å¯ç”¨å¯¹è±¡ç¼“å­˜ | è¯»å¯†é›†åœºæ™¯ |
| **etcdä¼˜åŒ–** | è°ƒæ•´etcdæ€§èƒ½å‚æ•° | å­˜å‚¨å±‚ç“¶é¢ˆ |

---

## 4. è®¤è¯æˆæƒæ•…éšœæ’æŸ¥ (Authentication & Authorization)

### 4.1 è®¤è¯æ•…éšœè¯Šæ–­

```bash
# ========== 1. è®¤è¯é…ç½®æ£€æŸ¥ ==========

# æ£€æŸ¥è®¤è¯é…ç½®
cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep -A20 "authentication"

# æ£€æŸ¥å®¢æˆ·ç«¯è¯ä¹¦
openssl x509 -in ~/.kube/config -noout -text | head -20

# æ£€æŸ¥tokenæœ‰æ•ˆæ€§
kubectl config view --raw -o jsonpath='{.users[0].user.token}'

# ========== 2. å¸¸è§è®¤è¯é”™è¯¯ ==========

# Tokenè¿‡æœŸ
# é”™è¯¯: "Unauthorized"
# è§£å†³: kubeadm token create æˆ–æ›´æ–°kubeconfig

# è¯ä¹¦è¿‡æœŸ
# é”™è¯¯: "x509: certificate has expired"
# è§£å†³: kubeadm certs renew all

# ServiceAccount Tokenå¤±æ•ˆ
# é”™è¯¯: "Unauthorized" for service account
# è§£å†³: åˆ é™¤é‡å»ºServiceAccountæˆ–æ›´æ–°secret
```

### 4.2 æˆæƒæ•…éšœè¯Šæ–­

```bash
# ========== 1. æƒé™æ£€æŸ¥ ==========

# æ£€æŸ¥ç”¨æˆ·æƒé™
kubectl auth can-i list pods --as=system:serviceaccount:default:my-sa
kubectl auth can-i create deployments --as=user@example.com -n production

# æŸ¥çœ‹ç”¨æˆ·ç»‘å®šçš„è§’è‰²
kubectl get rolebindings,clusterrolebindings -A | grep "user@example.com"

# ========== 2. RBACé…ç½®æ£€æŸ¥ ==========

# æ£€æŸ¥ClusterRole
kubectl get clusterroles | grep -E "(admin|edit|view)"

# æ£€æŸ¥RoleBinding
kubectl get rolebindings -n <namespace> -o yaml

# ========== 3. å¸¸è§æˆæƒé”™è¯¯ ==========

# 403 Forbidden
# åŸå› : æƒé™ä¸è¶³
# è§£å†³: æ£€æŸ¥RBACé…ç½®ï¼Œæ·»åŠ ç›¸åº”æƒé™

# User "system:anonymous" cannot...
# åŸå› : è®¤è¯å¤±è´¥å¯¼è‡´åŒ¿åè®¿é—®
# è§£å†³: æ£€æŸ¥å®¢æˆ·ç«¯è¯ä¹¦/tokené…ç½®
```

---

## 5. ç”Ÿäº§ç¯å¢ƒåº”æ€¥å¤„ç† (Production Emergency Response)

### 5.1 ç´§æ€¥æ¢å¤æ“ä½œ

```bash
# ========== 1. å¿«é€Ÿè¯Šæ–­è„šæœ¬ ==========

#!/bin/bash
# api-server-emergency-check.sh

echo "=== API Server ç´§æ€¥è¯Šæ–­ ==="
echo "æ—¶é—´: $(date)"
echo ""

# 1. æ£€æŸ¥API Serverå¥åº·çŠ¶æ€
echo "1. API Serverå¥åº·æ£€æŸ¥:"
curl -sk https://localhost:6443/healthz || echo "âŒ API Serverä¸å¥åº·"
echo ""

# 2. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
echo "2. è¿›ç¨‹çŠ¶æ€:"
systemctl status kube-apiserver --no-pager || echo "âŒ kube-apiserveræœåŠ¡å¼‚å¸¸"
echo ""

# 3. æ£€æŸ¥etcdè¿æ¥
echo "3. etcdè¿æ¥æ£€æŸ¥:"
ETCDCTL_API=3 etcdctl endpoint health --cluster 2>/dev/null || echo "âŒ etcdè¿æ¥å¼‚å¸¸"
echo ""

# 4. æ£€æŸ¥æœ€è¿‘é”™è¯¯æ—¥å¿—
echo "4. æœ€è¿‘é”™è¯¯æ—¥å¿—:"
journalctl -u kube-apiserver --since "10 minutes ago" | grep -i "error\|fatal\|panic" | tail -10
echo ""

# 5. æ£€æŸ¥èµ„æºä½¿ç”¨
echo "5. èµ„æºä½¿ç”¨æƒ…å†µ:"
echo "CPU: $(top -bn1 | grep kube-apiserver | awk '{print $9"%"}')"
echo "å†…å­˜: $(ps -o pid,rss,comm -C kube-apiserver --no-headers | awk '{sum+=$2} END {print sum/1024 "MB"}')"

# ========== 2. åº”æ€¥æ¢å¤å‘½ä»¤ ==========

# é‡å¯API Server
systemctl restart kube-apiserver

# å¦‚æœä½¿ç”¨é™æ€Pod
mv /etc/kubernetes/manifests/kube-apiserver.yaml /tmp/
sleep 5
mv /tmp/kube-apiserver.yaml /etc/kubernetes/manifests/

# æ£€æŸ¥æ¢å¤çŠ¶æ€
watch -n 2 'curl -sk https://localhost:6443/healthz'
```

### 5.2 æ•…éšœå‡çº§æµç¨‹

| æ•…éšœç­‰çº§ | å“åº”æ—¶é—´ | å¤„ç†æµç¨‹ |
|---------|---------|---------|
| **P0 - å®Œå…¨ä¸å¯ç”¨** | 15åˆ†é’Ÿå†… | ç«‹å³å¬é›†å€¼ç­å›¢é˜Ÿï¼Œæ‰§è¡Œåº”æ€¥é¢„æ¡ˆ |
| **P1 - æ€§èƒ½ä¸¥é‡ä¸‹é™** | 1å°æ—¶å†… | é€šçŸ¥äºŒçº¿æ”¯æŒï¼Œå‡†å¤‡æ‰©å®¹æ–¹æ¡ˆ |
| **P2 - åŠŸèƒ½å¼‚å¸¸** | 4å°æ—¶å†… | è®°å½•é—®é¢˜ï¼Œå®‰æ’ä¿®å¤è®¡åˆ’ |
| **P3 - è½»å¾®é—®é¢˜** | 24å°æ—¶å†… | æ­£å¸¸å·¥å•å¤„ç† |

---

## 6. é¢„é˜²æªæ–½ä¸æœ€ä½³å®è·µ (Prevention & Best Practices)

### 6.1 ç›‘æ§å‘Šè­¦é…ç½®

```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
- name: apiserver.rules
  rules:
  # API Serverä¸å¯ç”¨
  - alert: APIServerDown
    expr: up{job="apiserver"} == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "API Serverå®ä¾‹ {{ $labels.instance }} ä¸å¯ç”¨"
      
  # API Serverå“åº”æ…¢
  - alert: APIServerLatencyHigh
    expr: histogram_quantile(0.99, rate(apiserver_request_duration_seconds_bucket[5m])) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "API Server 99th percentile latency > 1s"
      
  # API Serveré™æµä¸¥é‡
  - alert: APIServerDroppingRequests
    expr: rate(apiserver_dropped_requests_total[5m]) > 10
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "API Serveræ­£åœ¨å¤§é‡ä¸¢å¼ƒè¯·æ±‚"
```

### 6.2 è¿ç»´æ£€æŸ¥æ¸…å•

- [ ] å®šæœŸæ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆæ¯æœˆï¼‰
- [ ] ç›‘æ§API Serverèµ„æºä½¿ç”¨ç‡
- [ ] éªŒè¯è´Ÿè½½å‡è¡¡å™¨å¥åº·æ£€æŸ¥é…ç½®
- [ ] æµ‹è¯•API Serveræ•…éšœæ¢å¤æµç¨‹
- [ ] å®šæœŸå®¡æŸ¥APFé…ç½®åˆç†æ€§
- [ ] ä¿æŒetcdé›†ç¾¤å¥åº·ç¨³å®š
- [ ] ç»´æŠ¤API Serveré…ç½®å¤‡ä»½

---