<!DOCTYPE HTML>
<html lang="zh-CN" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>141 - CNI 架构与核心原理 (CNI Architecture &amp; Fundamentals) - KUDIG-DATABASE - Kubernetes 生产运维全域知识库</title>


        <!-- Custom HTML head -->

        <meta name="description" content="面向生产环境的 Kubernetes + AI Infrastructure 运维全域知识库">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom-70c25c6f.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "navy";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-1731bb1c.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-35217294.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">KUDIG-DATABASE - Kubernetes 生产运维全域知识库</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/kudig-io/kudig-database" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="141---cni-架构与核心原理-cni-architecture--fundamentals"><a class="header" href="#141---cni-架构与核心原理-cni-architecture--fundamentals">141 - CNI 架构与核心原理 (CNI Architecture &amp; Fundamentals)</a></h1>
<blockquote>
<p><strong>适用版本</strong>: Kubernetes v1.25 - v1.32 | <strong>难度</strong>: 高级 | <strong>最后更新</strong>: 2026-01</p>
</blockquote>
<hr>
<h2 id="1-kubernetes-网络模型"><a class="header" href="#1-kubernetes-网络模型">1. Kubernetes 网络模型</a></h2>
<h3 id="核心原则"><a class="header" href="#核心原则">核心原则</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">原则</th><th style="text-align: left">说明</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><strong>Pod 间通信</strong></td><td style="text-align: left">所有 Pod 可以直接通信，无需 NAT</td></tr>
<tr><td style="text-align: left"><strong>Node-Pod 通信</strong></td><td style="text-align: left">节点可以直接与所有 Pod 通信</td></tr>
<tr><td style="text-align: left"><strong>Pod IP 一致性</strong></td><td style="text-align: left">Pod 看到的自身 IP 与其他 Pod 看到的相同</td></tr>
</tbody>
</table>
</div>
<h3 id="网络分层架构"><a class="header" href="#网络分层架构">网络分层架构</a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes 网络栈                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 4: Service 层                                            │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │ ClusterIP   │  │  NodePort   │  │LoadBalancer │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 3: kube-proxy 层                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │  iptables   │  │    IPVS     │  │  eBPF/nft   │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 2: CNI 层                                                │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │   Flannel   │  │   Calico    │  │   Cilium    │             │   │
│   │  │   Terway    │  │   Antrea    │  │  WeaveNet   │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Layer 1: 物理/虚拟网络                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│   │  │   VXLAN     │  │    BGP      │  │  VPC/ENI    │             │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr>
<h2 id="2-cni-规范与接口"><a class="header" href="#2-cni-规范与接口">2. CNI 规范与接口</a></h2>
<h3 id="21-cni-操作类型"><a class="header" href="#21-cni-操作类型">2.1 CNI 操作类型</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">操作</th><th style="text-align: left">触发时机</th><th style="text-align: left">说明</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><strong>ADD</strong></td><td style="text-align: left">Pod 创建</td><td style="text-align: left">创建网络命名空间、分配 IP、配置路由</td></tr>
<tr><td style="text-align: left"><strong>DEL</strong></td><td style="text-align: left">Pod 删除</td><td style="text-align: left">清理网络资源、释放 IP</td></tr>
<tr><td style="text-align: left"><strong>CHECK</strong></td><td style="text-align: left">健康检查</td><td style="text-align: left">验证网络配置正确性 (可选)</td></tr>
<tr><td style="text-align: left"><strong>VERSION</strong></td><td style="text-align: left">版本查询</td><td style="text-align: left">返回支持的 CNI 版本</td></tr>
</tbody>
</table>
</div>
<h3 id="22-cni-配置文件结构"><a class="header" href="#22-cni-配置文件结构">2.2 CNI 配置文件结构</a></h3>
<pre><code class="language-json">{
  "cniVersion": "1.0.0",
  "name": "k8s-pod-network",
  "plugins": [
    {
      "type": "calico",
      "log_level": "info",
      "datastore_type": "kubernetes",
      "nodename": "__KUBERNETES_NODE_NAME__",
      "mtu": 1440,
      "ipam": {
        "type": "calico-ipam"
      },
      "policy": {
        "type": "k8s"
      },
      "kubernetes": {
        "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
      }
    },
    {
      "type": "portmap",
      "snat": true,
      "capabilities": {"portMappings": true}
    },
    {
      "type": "bandwidth",
      "capabilities": {"bandwidth": true}
    }
  ]
}
</code></pre>
<h3 id="23-cni-环境变量"><a class="header" href="#23-cni-环境变量">2.3 CNI 环境变量</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">变量</th><th style="text-align: left">说明</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><code>CNI_COMMAND</code></td><td style="text-align: left">ADD/DEL/CHECK/VERSION</td></tr>
<tr><td style="text-align: left"><code>CNI_CONTAINERID</code></td><td style="text-align: left">容器 ID</td></tr>
<tr><td style="text-align: left"><code>CNI_NETNS</code></td><td style="text-align: left">网络命名空间路径</td></tr>
<tr><td style="text-align: left"><code>CNI_IFNAME</code></td><td style="text-align: left">接口名称 (通常为 eth0)</td></tr>
<tr><td style="text-align: left"><code>CNI_PATH</code></td><td style="text-align: left">CNI 插件搜索路径</td></tr>
<tr><td style="text-align: left"><code>CNI_ARGS</code></td><td style="text-align: left">额外参数</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="3-pod-网络创建流程"><a class="header" href="#3-pod-网络创建流程">3. Pod 网络创建流程</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                        Pod 网络初始化流程                                │
└─────────────────────────────────────────────────────────────────────────┘

  API Server              kubelet                CNI Plugin           IPAM
      │                      │                      │                  │
      │  1. Pod 调度到节点   │                      │                  │
      ├─────────────────────▶│                      │                  │
      │                      │                      │                  │
      │                      │  2. 创建 Sandbox     │                  │
      │                      ├────────┐             │                  │
      │                      │        │             │                  │
      │                      │◀───────┘             │                  │
      │                      │                      │                  │
      │                      │  3. 调用 CNI ADD     │                  │
      │                      ├─────────────────────▶│                  │
      │                      │                      │                  │
      │                      │                      │  4. 请求 IP      │
      │                      │                      ├─────────────────▶│
      │                      │                      │                  │
      │                      │                      │  5. 分配 IP      │
      │                      │                      │◀─────────────────┤
      │                      │                      │                  │
      │                      │                      │  6. 创建 veth    │
      │                      │                      ├────────┐         │
      │                      │                      │        │         │
      │                      │                      │◀───────┘         │
      │                      │                      │                  │
      │                      │                      │  7. 配置路由     │
      │                      │                      ├────────┐         │
      │                      │                      │        │         │
      │                      │                      │◀───────┘         │
      │                      │                      │                  │
      │                      │  8. 返回 IP 配置     │                  │
      │                      │◀─────────────────────┤                  │
      │                      │                      │                  │
      │                      │  9. 启动容器         │                  │
      │                      ├────────┐             │                  │
      │                      │        │             │                  │
      │                      │◀───────┘             │                  │
      │                      │                      │                  │
</code></pre>
<hr>
<h2 id="4-cni-插件对比"><a class="header" href="#4-cni-插件对比">4. CNI 插件对比</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">特性</th><th style="text-align: center">Flannel</th><th style="text-align: center">Calico</th><th style="text-align: center">Cilium</th><th style="text-align: center">Terway</th><th style="text-align: center">Antrea</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><strong>网络模式</strong></td><td style="text-align: center">Overlay</td><td style="text-align: center">Overlay/BGP</td><td style="text-align: center">Overlay/Native</td><td style="text-align: center">VPC</td><td style="text-align: center">Overlay/NoEncap</td></tr>
<tr><td style="text-align: left"><strong>NetworkPolicy</strong></td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: left"><strong>eBPF 支持</strong></td><td style="text-align: center">❌</td><td style="text-align: center">✅ (部分)</td><td style="text-align: center">✅ (原生)</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: left"><strong>加密</strong></td><td style="text-align: center">❌</td><td style="text-align: center">✅ (WireGuard)</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">✅ (IPSec)</td></tr>
<tr><td style="text-align: left"><strong>多集群</strong></td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: left"><strong>Service Mesh</strong></td><td style="text-align: center">❌</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td></tr>
<tr><td style="text-align: left"><strong>Windows</strong></td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: left"><strong>复杂度</strong></td><td style="text-align: center">低</td><td style="text-align: center">中</td><td style="text-align: center">高</td><td style="text-align: center">中</td><td style="text-align: center">中</td></tr>
<tr><td style="text-align: left"><strong>性能</strong></td><td style="text-align: center">中</td><td style="text-align: center">高</td><td style="text-align: center">高</td><td style="text-align: center">高</td><td style="text-align: center">高</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="5-overlay-网络原理"><a class="header" href="#5-overlay-网络原理">5. Overlay 网络原理</a></h2>
<h3 id="51-vxlan-封装"><a class="header" href="#51-vxlan-封装">5.1 VXLAN 封装</a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                         VXLAN 封装结构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   原始数据包:                                                            │
│   ┌────────────┬────────────┬────────────┬──────────────────────────┐   │
│   │  Pod Eth   │   Pod IP   │    TCP     │        Payload           │   │
│   │   Header   │   Header   │   Header   │                          │   │
│   └────────────┴────────────┴────────────┴──────────────────────────┘   │
│                                                                          │
│   VXLAN 封装后:                                                          │
│   ┌──────────┬──────────┬────────┬────────┬────────────────────────┐    │
│   │ Outer    │ Outer IP │  UDP   │ VXLAN  │    原始数据包          │    │
│   │ Ethernet │  Header  │ Header │ Header │    (上面的内容)        │    │
│   │ 14 bytes │ 20 bytes │8 bytes │8 bytes │                        │    │
│   └──────────┴──────────┴────────┴────────┴────────────────────────┘    │
│                                                                          │
│   额外开销: 50 bytes (MTU: 1500 → 实际 1450)                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="52-vxlan-跨节点通信"><a class="header" href="#52-vxlan-跨节点通信">5.2 VXLAN 跨节点通信</a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│  Node 1 (10.0.1.10)                  Node 2 (10.0.1.20)                 │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │  Pod A              │             │  Pod B              │            │
│  │  IP: 10.244.1.10    │             │  IP: 10.244.2.20    │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │ veth                                 │ veth                │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │     cni0 Bridge     │             │     cni0 Bridge     │            │
│  │  IP: 10.244.1.1     │             │  IP: 10.244.2.1     │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │                                      │                     │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │  flannel.1 (VTEP)   │────VXLAN───▶│  flannel.1 (VTEP)   │            │
│  │  IP: 10.244.1.0     │   隧道      │  IP: 10.244.2.0     │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │                                      │                     │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │       eth0          │             │       eth0          │            │
│  │  IP: 10.0.1.10      │─────────────│  IP: 10.0.1.20      │            │
│  └─────────────────────┘   物理网络   └─────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr>
<h2 id="6-路由模式原理-bgphost-gw"><a class="header" href="#6-路由模式原理-bgphost-gw">6. 路由模式原理 (BGP/host-gw)</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│  Node 1 (10.0.1.10)                  Node 2 (10.0.1.20)                 │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │  Pod A              │             │  Pod B              │            │
│  │  IP: 10.244.1.10    │             │  IP: 10.244.2.20    │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │ veth                                 │ veth                │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │      cali*          │             │      cali*          │            │
│  │   路由到 eth0       │             │   路由到 eth0       │            │
│  └─────────┬───────────┘             └───────────┬─────────┘            │
│            │                                      │                     │
│   路由表:                               路由表:                          │
│   10.244.2.0/24 via 10.0.1.20          10.244.1.0/24 via 10.0.1.10     │
│            │                                      │                     │
│            ▼                                      ▼                     │
│  ┌─────────────────────┐             ┌─────────────────────┐            │
│  │       eth0          │             │       eth0          │            │
│  │  IP: 10.0.1.10      │─────────────│  IP: 10.0.1.20      │            │
│  └─────────────────────┘   直接路由   └─────────────────────┘            │
│                         (无封装开销)                                     │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="路由模式优势"><a class="header" href="#路由模式优势">路由模式优势</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">特性</th><th style="text-align: left">Overlay (VXLAN)</th><th style="text-align: left">路由模式 (BGP)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left">MTU 开销</td><td style="text-align: left">~50 bytes</td><td style="text-align: left">0</td></tr>
<tr><td style="text-align: left">延迟</td><td style="text-align: left">较高</td><td style="text-align: left">较低</td></tr>
<tr><td style="text-align: left">网络要求</td><td style="text-align: left">无特殊要求</td><td style="text-align: left">L2 互通或 BGP 支持</td></tr>
<tr><td style="text-align: left">调试难度</td><td style="text-align: left">较高</td><td style="text-align: left">较低</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="7-ipam-ip-地址管理"><a class="header" href="#7-ipam-ip-地址管理">7. IPAM (IP 地址管理)</a></h2>
<h3 id="71-ipam-类型"><a class="header" href="#71-ipam-类型">7.1 IPAM 类型</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">类型</th><th style="text-align: left">说明</th><th style="text-align: left">适用场景</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><strong>host-local</strong></td><td style="text-align: left">每节点独立 IP 段</td><td style="text-align: left">Flannel</td></tr>
<tr><td style="text-align: left"><strong>calico-ipam</strong></td><td style="text-align: left">全局 IP 池，按块分配</td><td style="text-align: left">Calico</td></tr>
<tr><td style="text-align: left"><strong>whereabouts</strong></td><td style="text-align: left">跨节点 IP 池</td><td style="text-align: left">多租户</td></tr>
<tr><td style="text-align: left"><strong>VPC IPAM</strong></td><td style="text-align: left">云厂商 VPC IP 直接分配</td><td style="text-align: left">Terway、AWS VPC CNI</td></tr>
</tbody>
</table>
</div>
<h3 id="72-calico-ippool-配置"><a class="header" href="#72-calico-ippool-配置">7.2 Calico IPPool 配置</a></h3>
<pre><code class="language-yaml">apiVersion: crd.projectcalico.org/v1
kind: IPPool
metadata:
  name: default-ippool
spec:
  cidr: 10.244.0.0/16
  ipipMode: CrossSubnet      # 跨子网使用 IPIP
  vxlanMode: Never
  natOutgoing: true
  nodeSelector: all()
  blockSize: 26              # 每节点 64 个 IP (/26)
---
# 特定节点池
apiVersion: crd.projectcalico.org/v1
kind: IPPool
metadata:
  name: gpu-node-pool
spec:
  cidr: 10.245.0.0/16
  ipipMode: Always
  natOutgoing: true
  nodeSelector: hardware == 'gpu'
</code></pre>
<hr>
<h2 id="8-故障排查"><a class="header" href="#8-故障排查">8. 故障排查</a></h2>
<h3 id="81-常用诊断命令"><a class="header" href="#81-常用诊断命令">8.1 常用诊断命令</a></h3>
<pre><code class="language-bash"># 查看 CNI 配置
ls -la /etc/cni/net.d/
cat /etc/cni/net.d/10-calico.conflist

# 查看 CNI 插件
ls -la /opt/cni/bin/

# 查看 Pod 网络命名空间
crictl pods
crictl inspectp &lt;pod-id&gt; | jq '.info.runtimeSpec.linux.namespaces'

# 进入 Pod 网络命名空间
nsenter -t $(crictl inspect &lt;container-id&gt; | jq '.info.pid') -n ip addr

# 检查路由表
ip route show
ip route get &lt;pod-ip&gt;

# 检查 VXLAN 接口
ip -d link show flannel.1
bridge fdb show dev flannel.1

# 抓包分析
tcpdump -i eth0 -n port 4789  # VXLAN
tcpdump -i cali+ -n           # Calico 接口
</code></pre>
<h3 id="82-常见问题"><a class="header" href="#82-常见问题">8.2 常见问题</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">问题</th><th style="text-align: left">可能原因</th><th style="text-align: left">解决方案</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left">Pod 无法获取 IP</td><td style="text-align: left">CNI 插件未安装/配置错误</td><td style="text-align: left">检查 /etc/cni/net.d/</td></tr>
<tr><td style="text-align: left">Pod 间无法通信</td><td style="text-align: left">网络策略/路由问题</td><td style="text-align: left">检查 NetworkPolicy、路由表</td></tr>
<tr><td style="text-align: left">跨节点通信失败</td><td style="text-align: left">防火墙/VXLAN 端口</td><td style="text-align: left">检查 UDP 4789/8472</td></tr>
<tr><td style="text-align: left">DNS 解析失败</td><td style="text-align: left">CoreDNS 问题</td><td style="text-align: left">检查 CoreDNS Pod 状态</td></tr>
<tr><td style="text-align: left">网络性能差</td><td style="text-align: left">MTU 配置不当</td><td style="text-align: left">调整 MTU (VXLAN: 1450)</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="9-最佳实践"><a class="header" href="#9-最佳实践">9. 最佳实践</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">类别</th><th style="text-align: left">建议</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><strong>CNI 选择</strong></td><td style="text-align: left">简单场景用 Flannel，需要 NetworkPolicy 用 Calico/Cilium</td></tr>
<tr><td style="text-align: left"><strong>网络模式</strong></td><td style="text-align: left">同子网用 host-gw/BGP，跨子网用 VXLAN</td></tr>
<tr><td style="text-align: left"><strong>MTU</strong></td><td style="text-align: left">VXLAN 设置为 1450，避免分片</td></tr>
<tr><td style="text-align: left"><strong>IP 规划</strong></td><td style="text-align: left">预留足够的 Pod CIDR，避免与 VPC 冲突</td></tr>
<tr><td style="text-align: left"><strong>NetworkPolicy</strong></td><td style="text-align: left">默认拒绝，显式允许</td></tr>
<tr><td style="text-align: left"><strong>监控</strong></td><td style="text-align: left">监控 CNI Pod 状态、网络延迟</td></tr>
</tbody>
</table>
</div>
<hr>
<hr>
<h2 id="10-生产环境cni运维实践"><a class="header" href="#10-生产环境cni运维实践">10. 生产环境CNI运维实践</a></h2>
<h3 id="101-cni插件选型指南"><a class="header" href="#101-cni插件选型指南">10.1 CNI插件选型指南</a></h3>
<pre><code class="language-markdown">## CNI插件选型决策矩阵

| 场景 | 推荐插件 | 理由 | 注意事项 |
|------|----------|------|----------|
| **公有云环境** | Calico | 性能优秀，支持NetworkPolicy | 需要BGP配置优化 |
| **混合云环境** | Cilium | eBPF强大，安全功能丰富 | 内核版本要求≥4.19 |
| **阿里云ACK** | Terway | 阿里云原生优化 | 仅适用于ACK环境 |
| **简单网络需求** | Flannel | 配置简单，易于维护 | 不支持NetworkPolicy |
| **企业级安全** | Calico | 企业级安全策略 | 需要额外学习成本 |

### 性能基准测试结果
- **Calico VXLAN模式**: 8.2 Gbps 吞吐量
- **Cilium eBPF模式**: 12.1 Gbps 吞吐量  
- **Flannel VXLAN模式**: 6.8 Gbps 吞吐量
- **Terway ENI模式**: 25 Gbps 吞吐量（接近物理网卡极限）
</code></pre>
<h3 id="102-cni高可用部署配置"><a class="header" href="#102-cni高可用部署配置">10.2 CNI高可用部署配置</a></h3>
<pre><code class="language-yaml"># Calico生产环境高可用配置
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  # 高可用配置
  calicoNetwork:
    ipPools:
    - cidr: 10.244.0.0/16
      encapsulation: VXLANCrossSubnet
      natOutgoing: Enabled
      blockSize: 26
    nodeAddressAutodetectionV4:
      # 自动检测主网络接口
      interface: "eth.*"
  
  # 组件资源配置
  componentResources:
  - componentName: Node
    resourceRequirements:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
  
  # 高可用设置
  nodeMetricsPort: 9091
  typhaMetricsPort: 9093
  
---
# Typha高可用部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: calico-typha
  namespace: calico-system
spec:
  replicas: 3  # 至少3个副本保证高可用
  selector:
    matchLabels:
      k8s-app: calico-typha
  template:
    metadata:
      labels:
        k8s-app: calico-typha
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  k8s-app: calico-typha
              topologyKey: kubernetes.io/hostname
      containers:
      - name: calico-typha
        image: docker.io/calico/typha:v3.26.1
        env:
        - name: TYPHA_LOGSEVERITYSCREEN
          value: "info"
        - name: TYPHA_HEALTHENABLED
          value: "true"
        - name: TYPHA_HEALTHPORT
          value: "9098"
        readinessProbe:
          httpGet:
            path: /readiness
            port: 9098
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /liveness
            port: 9098
          initialDelaySeconds: 30
          periodSeconds: 10
</code></pre>
<h3 id="103-cni故障诊断与恢复"><a class="header" href="#103-cni故障诊断与恢复">10.3 CNI故障诊断与恢复</a></h3>
<pre><code class="language-bash">#!/bin/bash
# cni-troubleshooting.sh - CNI故障诊断脚本

set -euo pipefail

echo "=== CNI故障诊断工具 ==="
echo "诊断时间: $(date)"
echo

# 1. CNI插件识别
echo "[1/7] 识别CNI插件..."
CNI_PLUGIN=""
if kubectl get pods -n kube-system | grep -q calico; then
  CNI_PLUGIN="calico"
  echo "检测到 Calico CNI"
elif kubectl get pods -n kube-system | grep -q cilium; then
  CNI_PLUGIN="cilium"
  echo "检测到 Cilium CNI"
elif kubectl get pods -n kube-system | grep -q flannel; then
  CNI_PLUGIN="flannel"
  echo "检测到 Flannel CNI"
elif kubectl get pods -n kube-system | grep -q terway; then
  CNI_PLUGIN="terway"
  echo "检测到 Terway CNI"
else
  echo "未识别到标准CNI插件"
  exit 1
fi

# 2. CNI配置检查
echo "[2/7] 检查CNI配置..."
{
  echo "=== CNI配置检查 ==="
  echo "CNI插件: ${CNI_PLUGIN}"
  echo "配置文件列表:"
  kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
    head -3 | while read node; do
      echo "--- Node: $node ---"
      kubectl debug node/$node -it --image=nicolaka/netshoot -- ls /etc/cni/net.d/ 2&gt;/dev/null || echo "无法访问"
    done
} &gt; /tmp/cni-config-check.log

# 3. CNI Pod状态检查
echo "[3/7] 检查CNI Pod状态..."
{
  echo "=== CNI Pod状态 ==="
  case $CNI_PLUGIN in
    "calico")
      kubectl get pods -n calico-system -o wide
      echo -e "\nCalico节点状态:"
      kubectl exec -n calico-system -l k8s-app=calico-node -- calicoctl node status 2&gt;/dev/null || echo "calicoctl不可用"
      ;;
    "cilium")
      kubectl get pods -n kube-system -l k8s-app=cilium -o wide
      echo -e "\nCilium状态:"
      kubectl exec -n kube-system -l k8s-app=cilium -- cilium status 2&gt;/dev/null || echo "cilium命令不可用"
      ;;
    "flannel")
      kubectl get pods -n kube-system -l app=flannel -o wide
      ;;
    "terway")
      kubectl get pods -n kube-system -l app=terway -o wide
      echo -e "\nTerway诊断:"
      kubectl exec -n kube-system -l app=terway -- terway-cli version 2&gt;/dev/null || echo "terway-cli不可用"
      ;;
  esac
} &gt; /tmp/cni-pod-status.log

# 4. 网络连通性测试
echo "[4/7] 测试网络连通性..."
{
  echo "=== 网络连通性测试 ==="
  
  # 创建测试Pod
  cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: cni-test-pod-1
  labels:
    app: cni-test
spec:
  containers:
  - name: tester
    image: nicolaka/netshoot
    command: ["sleep", "3600"]
---
apiVersion: v1
kind: Pod
metadata:
  name: cni-test-pod-2
  labels:
    app: cni-test
spec:
  containers:
  - name: tester
    image: nicolaka/netshoot
    command: ["sleep", "3600"]
EOF

  sleep 10
  
  # 等待Pod就绪
  kubectl wait --for=condition=Ready pod/cni-test-pod-1 pod/cni-test-pod-2 --timeout=60s
  
  POD1_IP=$(kubectl get pod cni-test-pod-1 -o jsonpath='{.status.podIP}')
  POD2_IP=$(kubectl get pod cni-test-pod-2 -o jsonpath='{.status.podIP}')
  
  echo "测试Pod1 IP: $POD1_IP"
  echo "测试Pod2 IP: $POD2_IP"
  
  echo -e "\n跨Pod连通性测试:"
  kubectl exec cni-test-pod-1 -- ping -c 3 $POD2_IP
  
  echo -e "\nDNS解析测试:"
  kubectl exec cni-test-pod-1 -- nslookup kubernetes.default
  
  echo -e "\n外部网络测试:"
  kubectl exec cni-test-pod-1 -- ping -c 3 8.8.8.8
  
  # 清理测试Pod
  kubectl delete pod cni-test-pod-1 cni-test-pod-2 --force --grace-period=0
} &gt; /tmp/cni-connectivity-test.log

# 5. 日志分析
echo "[5/7] 收集CNI日志..."
{
  echo "=== CNI日志分析 ==="
  case $CNI_PLUGIN in
    "calico")
      echo "Calico节点日志采样:"
      kubectl logs -n calico-system -l k8s-app=calico-node --tail=100 | grep -E "(error|warn|failed)" || echo "未发现明显错误"
      ;;
    "cilium")
      echo "Cilium代理日志采样:"
      kubectl logs -n kube-system -l k8s-app=cilium --tail=100 | grep -E "(level=error|level=warning)" || echo "未发现明显错误"
      ;;
    "flannel")
      echo "Flannel日志采样:"
      kubectl logs -n kube-system -l app=flannel --tail=100 | grep -E "(E[0-9]|W[0-9])" || echo "未发现明显错误"
      ;;
    "terway")
      echo "Terway日志采样:"
      kubectl logs -n kube-system -l app=terway --tail=100 | grep -E "(error|Error)" || echo "未发现明显错误"
      ;;
  esac
} &gt; /tmp/cni-logs-analysis.log

# 6. 性能指标检查
echo "[6/7] 检查网络性能指标..."
{
  echo "=== 网络性能检查 ==="
  
  echo "节点网络接口状态:"
  kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
    head -3 | while read node; do
      echo "--- Node: $node ---"
      kubectl debug node/$node -it --image=nicolaka/netshoot -- \
        ss -i | grep -E "(eth|ens|eno)" | head -10
    done
  
  echo -e "\nconntrack使用情况:"
  kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
    head -3 | while read node; do
      echo "--- Node: $node ---"
      kubectl debug node/$node -it --image=nicolaka/netshoot -- \
        sh -c 'echo "current: $(cat /proc/sys/net/netfilter/nf_conntrack_count 2&gt;/dev/null || echo N/A)" &amp;&amp; echo "max: $(cat /proc/sys/net/netfilter/nf_conntrack_max 2&gt;/dev/null || echo N/A)"'
    done
} &gt; /tmp/cni-performance-check.log

# 7. 生成诊断报告
echo "[7/7] 生成诊断报告..."
{
  echo "=========================================="
  echo "           CNI插件诊断报告"
  echo "=========================================="
  echo "CNI插件类型: ${CNI_PLUGIN}"
  echo "诊断时间: $(date)"
  echo
  
  echo "=== 关键指标 ==="
  case $CNI_PLUGIN in
    "calico")
      echo "Calico节点数: $(kubectl get pods -n calico-system -l k8s-app=calico-node --no-headers | wc -l)"
      echo "Calico运行状态: $(kubectl get pods -n calico-system -l k8s-app=calico-node --no-headers | grep Running | wc -l)/$(kubectl get pods -n calico-system -l k8s-app=calico-node --no-headers | wc -l)"
      ;;
    "cilium")
      echo "Cilium节点数: $(kubectl get pods -n kube-system -l k8s-app=cilium --no-headers | wc -l)"
      echo "Cilium运行状态: $(kubectl get pods -n kube-system -l k8s-app=cilium --no-headers | grep Running | wc -l)/$(kubectl get pods -n kube-system -l k8s-app=cilium --no-headers | wc -l)"
      ;;
  esac
  
  echo
  echo "=== 发现的问题 ==="
  if grep -q "error\|Error\|failed\|Failed" /tmp/cni-logs-analysis.log; then
    echo "⚠️  发现CNI错误日志"
  fi
  
  if ! kubectl exec cni-test-pod-1 -- ping -c 1 $POD2_IP &gt;/dev/null 2&gt;&amp;1; then
    echo "⚠️  Pod间网络连通性异常"
  fi
  
  echo
  echo "=== 建议操作 ==="
  echo "1. 详细日志已保存至临时文件"
  echo "2. 如需进一步分析，请查看对应日志文件"
  echo "3. 常见解决方案:"
  case $CNI_PLUGIN in
    "calico")
      echo "   - 重启calico-node Pod: kubectl delete pod -n calico-system -l k8s-app=calico-node"
      echo "   - 检查BGP peer状态: calicoctl node status"
      ;;
    "cilium")
      echo "   - 重启cilium-agent: kubectl delete pod -n kube-system -l k8s-app=cilium"
      echo "   - 检查eBPF状态: cilium status"
      ;;
    "flannel")
      echo "   - 重启kube-flannel-ds: kubectl delete pod -n kube-system -l app=flannel"
      echo "   - 检查子网分配: kubectl logs -n kube-system -l app=flannel"
      ;;
  esac
} &gt; /tmp/cni-diagnosis-report.txt

echo
echo "=== 诊断完成 ==="
echo "诊断报告: /tmp/cni-diagnosis-report.txt"
echo "各检查项日志已分别保存"
</code></pre>
<h3 id="104-cni安全加固配置"><a class="header" href="#104-cni安全加固配置">10.4 CNI安全加固配置</a></h3>
<pre><code class="language-yaml"># CNI网络安全加固配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: cni-security-config
  namespace: kube-system
data:
  # Calico安全配置
  calico-security.yaml: |
    apiVersion: projectcalico.org/v3
    kind: FelixConfiguration
    metadata:
      name: default
    spec:
      # 启用日志记录
      logSeverityScreen: Info
      
      # 网络策略强制执行
      policySyncPathPrefix: /var/run/nodeagent
      
      # 安全特性
      reportingInterval: 0s  # 禁用定期报告
      endpointReportingEnabled: true
      endpointReportingDelay: 1s
      
      # 资源限制
      healthPort: 9099
      prometheusMetricsEnabled: true
      
      # 安全扫描
      iptablesLockTimeoutSecs: 30
      iptablesRefreshInterval: 90
      
      # 防御配置
      failsafeInboundHostPorts:
      - protocol: TCP
        port: 22    # SSH
        net: 0.0.0.0/0
      - protocol: TCP
        port: 10250 # Kubelet
        net: 0.0.0.0/0
      failsafeOutboundHostPorts:
      - protocol: UDP
        port: 53    # DNS
        net: 0.0.0.0/0
      - protocol: TCP
        port: 53    # DNS
        net: 0.0.0.0/0
  
  # Cilium安全配置
  cilium-security.yaml: |
    apiVersion: v2
    kind: CiliumConfig
    metadata:
      name: cilium
    spec:
      # 安全选项
      enable-ipv4: true
      enable-ipv6: false
      tunnel: vxlan
      
      # 策略执行模式
      policy-enforcement-mode: "always"  # 强制执行策略
      
      # 监控和日志
      monitor-aggregation: "medium"
      monitor-aggregation-flags: "all"
      log-driver: "fluentd"
      
      # 资源限制
      bpf-map-dynamic-size-ratio: "0.0025"
      preallocate-bpf-maps: "false"
      
      # 安全特性
      enable-l7-proxy: "true"
      enable-remote-node-identity: "true"
      enable-bandwidth-manager: "true"
</code></pre>
<h3 id="105-cni升级与回滚策略"><a class="header" href="#105-cni升级与回滚策略">10.5 CNI升级与回滚策略</a></h3>
<pre><code class="language-markdown">## CNI插件升级最佳实践

### 升级前准备
1. **备份配置**: 备份当前CNI配置和网络策略
2. **容量评估**: 确保集群有足够的资源
3. **兼容性检查**: 验证新版本与Kubernetes版本兼容性
4. **测试环境验证**: 在测试环境先行验证

### 滚动升级步骤
```bash
# 1. 检查当前版本
kubectl get pods -n kube-system -l k8s-app=calico-node -o jsonpath='{.items[0].spec.containers[0].image}'

# 2. 应用新配置
kubectl apply -f calico-new-version.yaml

# 3. 监控升级过程
watch kubectl get pods -n kube-system -l k8s-app=calico-node

# 4. 验证网络功能
./network-validation-script.sh

# 5. 回滚机制（如有问题）
kubectl apply -f calico-old-version.yaml
</code></pre>
<h3 id="回滚条件"><a class="header" href="#回滚条件">回滚条件</a></h3>
<ul>
<li>升级过程中出现大量Pod网络异常</li>
<li>核心业务服务不可达</li>
<li>监控指标异常（CPU/内存使用率激增）</li>
<li>日志中出现严重错误信息</li>
</ul>
<h3 id="验证清单"><a class="header" href="#验证清单">验证清单</a></h3>
<ul>
<li><input disabled="" type="checkbox"> Pod间网络连通性正常</li>
<li><input disabled="" type="checkbox"> Service访问正常</li>
<li><input disabled="" type="checkbox"> DNS解析正常</li>
<li><input disabled="" type="checkbox"> NetworkPolicy策略生效</li>
<li><input disabled="" type="checkbox"> 监控指标稳定</li>
<li><input disabled="" type="checkbox"> 无新增错误日志</li>
</ul>
<pre><code></code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../domain-5-networking/01-network-architecture-overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../../../domain-5-networking/03-cni-plugins-comparison.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../domain-5-networking/01-network-architecture-overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../../../domain-5-networking/03-cni-plugins-comparison.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
