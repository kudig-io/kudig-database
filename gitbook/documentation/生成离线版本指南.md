# GitBook 离线静态版本生成指南

## 简要说明

由于 Windows 环境下符号链接的复杂性，我已经为您：

1. ✅ 安装了 mdbook (位于 `C:\Users\Allen\.local\bin\mdbook.exe`)
2. ✅ 创建了多个生成脚本
3. ✅ 创建了 `generate-summary.ps1` (已修复方括号转义问题)

## 手动生成步骤（最可靠）

### 步骤 1：准备环境

```powershell
cd C:\Users\Allen\Documents\GitHub\kudig-io\kudig-database\gitbook

# 恢复原始配置
git checkout book.toml

# 确保 src 目录存在
if (!(Test-Path src)) { New-Item -ItemType Directory src }
```

### 步骤 2：创建链接

```powershell
# 删除旧的伪链接文件
Get-ChildItem src | Where-Object { $_.Name -like "domain-*" -or $_.Name -like "topic-*" } | Remove-Item -Recurse -Force

# 复制 README
Copy-Item ..\README.md src\README.md -Force

# 创建 Junction (需要每个目录单独执行)
# Domain 目录
1..33 | ForEach-Object {
    $dir = Get-ChildItem .. -Directory -Filter "domain-$_-*" | Select-Object -First 1
    if ($dir) {
        $link = "src\$($dir.Name)"
        cmd /c "mklink /J `"$link`" `"$($dir.FullName)`""
    }
}

# Topic 目录
Get-ChildItem .. -Directory -Filter "topic-*" | ForEach-Object {
    $link = "src\$($_.Name)"
    cmd /c "mklink /J `"$link`" `"$($_.FullName)`""
}
```

### 步骤 3：生成 SUMMARY.md

```powershell
.\generate-summary.ps1
```

### 步骤 4：修改配置构建

```powershell
# 备份配置
Copy-Item book.toml book.toml.bak

# 修改配置
$content = Get-Content book.toml -Raw -Encoding UTF8
$content = $content -replace '(?m)^site-url\s*=.*$', ''
$content = $content -replace 'build-dir\s*=\s*"book"', 'build-dir = "dist"'
Set-Content book.toml $content -NoNewline -Encoding UTF8

# 构建
C:\Users\Allen\.local\bin\mdbook.exe build

# 恢复配置
Move-Item book.toml.bak book.toml -Force
```

### 步骤 5：打开查看

```powershell
start dist\index.html
```

## 或者使用 Git Bash（推荐）

如果安装了 Git for Windows，可以直接使用原有的 bash 脚本：

```bash
cd /c/Users/Allen/Documents/GitHub/kudig-io/kudig-database/gitbook
bash export-static.sh
```

## 生成的文件

- `dist/` - 完整的静态网站目录
- `dist/index.html` - 入口文件
- 所有资源（CSS、JS、字体）都已内嵌或使用相对路径
- 可以直接拷贝整个 `dist` 文件夹到任何位置使用

## 打包为 ZIP

```powershell
Compress-Archive -Path "dist\*" -DestinationPath "kudig-gitbook-offline.zip" -CompressionLevel Optimal
```

## 故障排除

### 问题 1: "系统找不到指定的路径"

**原因**：符号链接未正确创建

**解决**：重新执行步骤 2

### 问题 2: "Summary parsing failed"

**原因**：SUMMARY.md 中有格式错误

**解决**：重新生成 SUMMARY.md (`.\generate-summary.ps1`)

### 问题 3: Junction 创建失败

**原因**：权限不足

**解决**：以管理员身份运行 PowerShell

## 已创建的脚本文件

- `install-mdbook.ps1` - mdbook 安装脚本（已运行成功）
- `generate-summary.ps1` - 目录生成脚本（已修复）
- `build-offline.ps1` - 完整构建脚本
- `export-static.ps1` - 导出脚本
- `export-static-simple.ps1` - 简化导出脚本

## 注意事项

1. Windows 符号链接需要特殊权限，Junction 是更好的选择
2. Git 在 Windows 上默认将符号链接存储为文本文件
3. 生成后的 dist 目录完全独立，可以离线使用
4. 建议定期重新生成以获取最新内容

## 联系支持

如果遇到问题，可以：
1. 检查 mdbook 版本：`C:\Users\Allen\.local\bin\mdbook.exe --version`
2. 查看详细错误：`C:\Users\Allen\.local\bin\mdbook.exe build -d dist`
3. 使用 Git Bash 环境（更稳定）
